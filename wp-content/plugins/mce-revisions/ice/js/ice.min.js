/**
Copyright (c) The New York Times, CMS Group, Matthew DeLambo

This program is free software; you can redistribute it and/or modify
it under the terms of the GNU General Public License, version 2, as
published by the Free Software Foundation.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program as the file license.txt. If not, see
<http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt>

**/
window.rangy=function(){function e(a,b){var d=typeof a[b];return d==r||!!(d==l&&a[b])||d=="unknown"}function b(a,b){return!!(typeof a[b]==l&&a[b])}function a(a,b){return typeof a[b]!=n}function d(a){return function(b,d){for(var f=d.length;f--;)if(!a(b,d[f]))return!1;return!0}}function f(a){return a&&k(a,t)&&y(a,i)}function g(a){window.alert("Rangy not supported in your browser. Reason: "+a);q.initialized=!0;q.supported=!1}function h(){if(!q.initialized){var a,d=!1,p=!1;e(document,"createRange")&&
(a=document.createRange(),k(a,o)&&y(a,s)&&(d=!0),a.detach());if((a=b(document,"body")?document.body:document.getElementsByTagName("body")[0])&&e(a,"createTextRange"))a=a.createTextRange(),f(a)&&(p=!0);!d&&!p&&g("Neither Range nor TextRange are implemented");q.initialized=!0;q.features={implementsDomRange:d,implementsTextRange:p};d=F.concat(x);p=0;for(a=d.length;p<a;++p)try{d[p](q)}catch(i){b(window,"console")&&e(window.console,"log")&&window.console.log("Init listener threw an exception. Continuing.",
i)}}}function j(a){this.name=a;this.supported=this.initialized=!1}var l="object",r="function",n="undefined",s=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer","START_TO_START","START_TO_END","END_TO_START","END_TO_END"],o=["setStart","setStartBefore","setStartAfter","setEnd","setEndBefore","setEndAfter","collapse","selectNode","selectNodeContents","compareBoundaryPoints","deleteContents","extractContents","cloneContents","insertNode","surroundContents",
"cloneRange","toString","detach"],i=["boundingHeight","boundingLeft","boundingTop","boundingWidth","htmlText","text"],t=["collapse","compareEndPoints","duplicate","getBookmark","moveToBookmark","moveToElementText","parentElement","pasteHTML","select","setEndPoint","getBoundingClientRect"],k=d(e),p=d(b),y=d(a),q={version:"1.2",initialized:!1,supported:!0,util:{isHostMethod:e,isHostObject:b,isHostProperty:a,areHostMethods:k,areHostObjects:p,areHostProperties:y,isTextRange:f},features:{},modules:{},
config:{alertOnWarn:!1,preferTextRange:!1}};q.fail=g;q.warn=function(a){a="Rangy warning: "+a;q.config.alertOnWarn?window.alert(a):typeof window.console!=n&&typeof window.console.log!=n&&window.console.log(a)};({}).hasOwnProperty?q.util.extend=function(a,b){for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d])}:g("hasOwnProperty not supported");var x=[],F=[];q.init=h;q.addInitListener=function(a){q.initialized?a(q):x.push(a)};var C=[];q.addCreateMissingNativeApiListener=function(a){C.push(a)};q.createMissingNativeApi=
function(a){a=a||window;h();for(var b=0,d=C.length;b<d;++b)C[b](a)};j.prototype.fail=function(a){this.initialized=!0;this.supported=!1;throw Error("Module '"+this.name+"' failed to load: "+a);};j.prototype.warn=function(a){q.warn("Module "+this.name+": "+a)};j.prototype.createError=function(a){return Error("Error in Rangy "+this.name+" module: "+a)};q.createModule=function(a,b){var d=new j(a);q.modules[a]=d;F.push(function(a){b(a,d);d.initialized=!0;d.supported=!0})};q.requireModules=function(a){for(var b=
0,d=a.length,f,e;b<d;++b){e=a[b];f=q.modules[e];if(!f||!(f instanceof j))throw Error("Module '"+e+"' not found");if(!f.supported)throw Error("Module '"+e+"' not supported");}};var A=!1,p=function(){A||(A=!0,q.initialized||h())};if(typeof window==n)g("No window found");else if(typeof document==n)g("No document found");else return e(document,"addEventListener")&&document.addEventListener("DOMContentLoaded",p,!1),e(window,"addEventListener")?window.addEventListener("load",p,!1):e(window,"attachEvent")?
window.attachEvent("onload",p):g("Window does not have required addEventListener or attachEvent method"),q}();
rangy.createModule("DomUtil",function(e,b){function a(a){for(var b=0;a=a.previousSibling;)b++;return b}function d(a,b){var d=[],f;for(f=a;f;f=f.parentNode)d.push(f);for(f=b;f;f=f.parentNode)if(k(d,f))return f;return null}function f(a,b,d){for(d=d?a:a.parentNode;d;){a=d.parentNode;if(a===b)return d;d=a}return null}function g(a){a=a.nodeType;return a==3||a==4||a==8}function h(a,b){var d=b.nextSibling,f=b.parentNode;d?f.insertBefore(a,d):f.appendChild(a);return a}function j(a){if(a.nodeType==9)return a;
else if(typeof a.ownerDocument!=o)return a.ownerDocument;else if(typeof a.document!=o)return a.document;else if(a.parentNode)return j(a.parentNode);else throw Error("getDocument: no document found for node");}function l(a){return!a?"[No node]":g(a)?'"'+a.data+'"':a.nodeType==1?"<"+a.nodeName+(a.id?' id="'+a.id+'"':"")+">["+a.childNodes.length+"]":a.nodeName}function r(a){this._next=this.root=a}function n(a,b){this.node=a;this.offset=b}function s(a){this.code=this[a];this.codeName=a;this.message="DOMException: "+
this.codeName}var o="undefined",i=e.util;i.areHostMethods(document,["createDocumentFragment","createElement","createTextNode"])||b.fail("document missing a Node creation method");i.isHostMethod(document,"getElementsByTagName")||b.fail("document missing getElementsByTagName method");var t=document.createElement("div");i.areHostMethods(t,["insertBefore","appendChild","cloneNode"])||b.fail("Incomplete Element implementation");t=document.createTextNode("test");i.areHostMethods(t,["splitText","deleteData",
"insertData","appendData","cloneNode"])||b.fail("Incomplete Text Node implementation");var k=function(a,b){for(var d=a.length;d--;)if(a[d]===b)return!0;return!1};r.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){var a=this._current=this._next,b;if(this._current){b=a.firstChild;if(!b)for(b=null;a!==this.root&&!(b=a.nextSibling);)a=a.parentNode;this._next=b}return this._current},detach:function(){this._current=this._next=this.root=null}};n.prototype={equals:function(a){return this.node===
a.node&this.offset==a.offset},inspect:function(){return"[DomPosition("+l(this.node)+":"+this.offset+")]"}};s.prototype={INDEX_SIZE_ERR:1,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INVALID_STATE_ERR:11};s.prototype.toString=function(){return this.message};e.dom={arrayContains:k,getNodeIndex:a,getNodeLength:function(a){var b;return g(a)?a.length:(b=a.childNodes)?b.length:0},getCommonAncestor:d,isAncestorOf:function(a,b,d){for(b=d?b:
b.parentNode;b;)if(b===a)return!0;else b=b.parentNode;return!1},getClosestAncestorIn:f,isCharacterDataNode:g,insertAfter:h,splitDataNode:function(a,b){var d=a.cloneNode(!1);d.deleteData(0,b);a.deleteData(b,a.length-b);h(d,a);return d},getDocument:j,getWindow:function(a){a=j(a);if(typeof a.defaultView!=o)return a.defaultView;else if(typeof a.parentWindow!=o)return a.parentWindow;else throw Error("Cannot get a window object for node");},getIframeWindow:function(a){if(typeof a.contentWindow!=o)return a.contentWindow;
else if(typeof a.contentDocument!=o)return a.contentDocument.defaultView;else throw Error("getIframeWindow: No Window object found for iframe element");},getIframeDocument:function(a){if(typeof a.contentDocument!=o)return a.contentDocument;else if(typeof a.contentWindow!=o)return a.contentWindow.document;else throw Error("getIframeWindow: No Document object found for iframe element");},getBody:function(a){return i.isHostObject(a,"body")?a.body:a.getElementsByTagName("body")[0]},getRootContainer:function(a){for(var b;b=
a.parentNode;)a=b;return a},comparePoints:function(b,e,g,k){var i;if(b==g)return e===k?0:e<k?-1:1;else if(i=f(g,b,!0))return e<=a(i)?-1:1;else if(i=f(b,g,!0))return a(i)<k?-1:1;else if(e=d(b,g),b=b===e?e:f(b,e,!0),g=g===e?e:f(g,e,!0),b===g)throw Error("comparePoints got to case 4 and childA and childB are the same!");else{for(e=e.firstChild;e;){if(e===b)return-1;else if(e===g)return 1;e=e.nextSibling}throw Error("Should not be here!");}},inspectNode:l,createIterator:function(a){return new r(a)},DomPosition:n};
e.DOMException=s});
rangy.createModule("DomRange",function(e){function b(a,b){return a.nodeType!=3&&(m.isAncestorOf(a,b.startContainer,!0)||m.isAncestorOf(a,b.endContainer,!0))}function a(a){return m.getDocument(a.startContainer)}function d(a,b,d){if(b=a._listeners[b])for(var f=0,e=b.length;f<e;++f)b[f].call(a,{target:a,args:d})}function f(a){return new v(a.parentNode,m.getNodeIndex(a))}function g(a){return new v(a.parentNode,m.getNodeIndex(a)+1)}function h(a,b,d){var f=a.nodeType==11?a.firstChild:a;m.isCharacterDataNode(b)?
d==b.length?m.insertAfter(a,b):b.parentNode.insertBefore(a,d==0?b:m.splitDataNode(b,d)):d>=b.childNodes.length?b.appendChild(a):b.insertBefore(a,b.childNodes[d]);return f}function j(b){for(var d,f,e=a(b.range).createDocumentFragment();f=b.next();){d=b.isPartiallySelectedSubtree();f=f.cloneNode(!d);d&&(d=b.getSubtreeIterator(),f.appendChild(j(d)),d.detach(!0));if(f.nodeType==10)throw new D("HIERARCHY_REQUEST_ERR");e.appendChild(f)}return e}function l(a,b,d){for(var f,e,d=d||{stop:!1};f=a.next();)if(a.isPartiallySelectedSubtree())if(b(f)===
!1){d.stop=!0;break}else{if(f=a.getSubtreeIterator(),l(f,b,d),f.detach(!0),d.stop)break}else for(f=m.createIterator(f);e=f.next();)if(b(e)===!1){d.stop=!0;return}}function r(a){for(var b;a.next();)a.isPartiallySelectedSubtree()?(b=a.getSubtreeIterator(),r(b),b.detach(!0)):a.remove()}function n(b){for(var d,f=a(b.range).createDocumentFragment(),e;d=b.next();){b.isPartiallySelectedSubtree()?(d=d.cloneNode(!1),e=b.getSubtreeIterator(),d.appendChild(n(e)),e.detach(!0)):b.remove();if(d.nodeType==10)throw new D("HIERARCHY_REQUEST_ERR");
f.appendChild(d)}return f}function s(a,b,d){var f=!(!b||!b.length),e,u=!!d;f&&(e=RegExp("^("+b.join("|")+")$"));var g=[];l(new i(a,!1),function(a){(!f||e.test(a.nodeType))&&(!u||d(a))&&g.push(a)});return g}function o(a){return"["+(typeof a.getName=="undefined"?"Range":a.getName())+"("+m.inspectNode(a.startContainer)+":"+a.startOffset+", "+m.inspectNode(a.endContainer)+":"+a.endOffset+")]"}function i(a,b){this.range=a;this.clonePartiallySelectedTextNodes=b;if(!a.collapsed){this.sc=a.startContainer;
this.so=a.startOffset;this.ec=a.endContainer;this.eo=a.endOffset;var d=a.commonAncestorContainer;this.sc===this.ec&&m.isCharacterDataNode(this.sc)?(this.isSingleCharacterDataNode=!0,this._first=this._last=this._next=this.sc):(this._first=this._next=this.sc===d&&!m.isCharacterDataNode(this.sc)?this.sc.childNodes[this.so]:m.getClosestAncestorIn(this.sc,d,!0),this._last=this.ec===d&&!m.isCharacterDataNode(this.ec)?this.ec.childNodes[this.eo-1]:m.getClosestAncestorIn(this.ec,d,!0))}}function t(a){this.code=
this[a];this.codeName=a;this.message="RangeException: "+this.codeName}function k(a,b,d){this.nodes=s(a,b,d);this._next=this.nodes[0];this._position=0}function p(a){return function(b,d){for(var f,e=d?b:b.parentNode;e;){f=e.nodeType;if(m.arrayContains(a,f))return e;e=e.parentNode}return null}}function y(a,b){if(Z(a,b))throw new t("INVALID_NODE_TYPE_ERR");}function q(a){if(!a.startContainer)throw new D("INVALID_STATE_ERR");}function x(a,b){if(!m.arrayContains(b,a.nodeType))throw new t("INVALID_NODE_TYPE_ERR");
}function F(a,b){if(b<0||b>(m.isCharacterDataNode(a)?a.length:a.childNodes.length))throw new D("INDEX_SIZE_ERR");}function C(a,b){if(L(a,!0)!==L(b,!0))throw new D("WRONG_DOCUMENT_ERR");}function A(a){if($(a,!0))throw new D("NO_MODIFICATION_ALLOWED_ERR");}function z(a,b){if(!a)throw new D(b);}function w(a){q(a);if(!m.arrayContains(J,a.startContainer.nodeType)&&!L(a.startContainer,!0)||!m.arrayContains(J,a.endContainer.nodeType)&&!L(a.endContainer,!0)||!(a.startOffset<=(m.isCharacterDataNode(a.startContainer)?
a.startContainer.length:a.startContainer.childNodes.length))||!(a.endOffset<=(m.isCharacterDataNode(a.endContainer)?a.endContainer.length:a.endContainer.childNodes.length)))throw Error("Range error: Range is no longer valid after DOM mutation ("+a.inspect()+")");}function H(){}function K(a){a.START_TO_START=R;a.START_TO_END=U;a.END_TO_END=aa;a.END_TO_START=V;a.NODE_BEFORE=W;a.NODE_AFTER=X;a.NODE_BEFORE_AND_AFTER=Y;a.NODE_INSIDE=S}function I(a){K(a);K(a.prototype)}function G(a,b){return function(){w(this);
var d=this.startContainer,f=this.startOffset,e=this.commonAncestorContainer,u=new i(this,!0);if(d!==e)d=m.getClosestAncestorIn(d,e,!0),f=g(d),d=f.node,f=f.offset;l(u,A);u.reset();e=a(u);u.detach();b(this,d,f,d,f);return e}}function B(a,d,k){function B(a,b){return function(d){q(this);x(d,O);x(u(d),J);d=(a?f:g)(d);(b?l:L)(this,d.node,d.offset)}}function l(a,b,f){var e=a.endContainer,g=a.endOffset;if(b!==a.startContainer||f!==this.startOffset){if(u(b)!=u(e)||m.comparePoints(b,f,e,g)==1)e=b,g=f;d(a,b,
f,e,g)}}function L(a,b,f){var e=a.startContainer,g=a.startOffset;if(b!==a.endContainer||f!==this.endOffset){if(u(b)!=u(e)||m.comparePoints(b,f,e,g)==-1)e=b,g=f;d(a,e,g,b,f)}}function h(a,b,f){(b!==a.startContainer||f!==this.startOffset||b!==a.endContainer||f!==this.endOffset)&&d(a,b,f,b,f)}a.prototype=new H;e.util.extend(a.prototype,{setStart:function(a,b){q(this);y(a,!0);F(a,b);l(this,a,b)},setEnd:function(a,b){q(this);y(a,!0);F(a,b);L(this,a,b)},setStartBefore:B(!0,!0),setStartAfter:B(!1,!0),setEndBefore:B(!0,
!1),setEndAfter:B(!1,!1),collapse:function(a){w(this);a?d(this,this.startContainer,this.startOffset,this.startContainer,this.startOffset):d(this,this.endContainer,this.endOffset,this.endContainer,this.endOffset)},selectNodeContents:function(a){q(this);y(a,!0);d(this,a,0,a,m.getNodeLength(a))},selectNode:function(a){q(this);y(a,!1);x(a,O);var b=f(a),a=g(a);d(this,b.node,b.offset,a.node,a.offset)},extractContents:G(n,d),deleteContents:G(r,d),canSurroundContents:function(){w(this);A(this.startContainer);
A(this.endContainer);var a=new i(this,!0),d=a._first&&b(a._first,this)||a._last&&b(a._last,this);a.detach();return!d},detach:function(){k(this)},splitBoundaries:function(){w(this);var a=this.startContainer,b=this.startOffset,f=this.endContainer,e=this.endOffset,u=a===f;m.isCharacterDataNode(f)&&e>0&&e<f.length&&m.splitDataNode(f,e);m.isCharacterDataNode(a)&&b>0&&b<a.length&&(a=m.splitDataNode(a,b),u?(e-=b,f=a):f==a.parentNode&&e>=m.getNodeIndex(a)&&e++,b=0);d(this,a,b,f,e)},normalizeBoundaries:function(){w(this);
var a=this.startContainer,b=this.startOffset,f=this.endContainer,e=this.endOffset,u=function(a){var b=a.nextSibling;if(b&&b.nodeType==a.nodeType)f=a,e=a.length,a.appendData(b.data),b.parentNode.removeChild(b)},g=function(d){var u=d.previousSibling;if(u&&u.nodeType==d.nodeType){a=d;var g=d.length;b=u.length;d.insertData(0,u.data);u.parentNode.removeChild(u);a==f?(e+=b,f=a):f==d.parentNode&&(u=m.getNodeIndex(d),e==u?(f=d,e=g):e>u&&e--)}},k=!0;m.isCharacterDataNode(f)?f.length==e&&u(f):(e>0&&(k=f.childNodes[e-
1])&&m.isCharacterDataNode(k)&&u(k),k=!this.collapsed);k?m.isCharacterDataNode(a)?b==0&&g(a):b<a.childNodes.length&&(u=a.childNodes[b])&&m.isCharacterDataNode(u)&&g(u):(a=f,b=e);d(this,a,b,f,e)},collapseToPoint:function(a,b){q(this);y(a,!0);F(a,b);h(this,a,b)}});I(a)}function P(a){a.collapsed=a.startContainer===a.endContainer&&a.startOffset===a.endOffset;a.commonAncestorContainer=a.collapsed?a.startContainer:m.getCommonAncestor(a.startContainer,a.endContainer)}function N(a,b,f,e,u){var g=a.startContainer!==
b||a.startOffset!==f,k=a.endContainer!==e||a.endOffset!==u;a.startContainer=b;a.startOffset=f;a.endContainer=e;a.endOffset=u;P(a);d(a,"boundarychange",{startMoved:g,endMoved:k})}function E(a){this.startContainer=a;this.startOffset=0;this.endContainer=a;this.endOffset=0;this._listeners={boundarychange:[],detach:[]};P(this)}e.requireModules(["DomUtil"]);var m=e.dom,v=m.DomPosition,D=e.DOMException;i.prototype={_current:null,_next:null,_first:null,_last:null,isSingleCharacterDataNode:!1,reset:function(){this._current=
null;this._next=this._first},hasNext:function(){return!!this._next},next:function(){var a=this._current=this._next;if(a)this._next=a!==this._last?a.nextSibling:null,m.isCharacterDataNode(a)&&this.clonePartiallySelectedTextNodes&&(a===this.ec&&(a=a.cloneNode(!0)).deleteData(this.eo,a.length-this.eo),this._current===this.sc&&(a=a.cloneNode(!0)).deleteData(0,this.so));return a},remove:function(){var a=this._current,b,d;m.isCharacterDataNode(a)&&(a===this.sc||a===this.ec)?(b=a===this.sc?this.so:0,d=a===
this.ec?this.eo:a.length,b!=d&&a.deleteData(b,d-b)):a.parentNode&&a.parentNode.removeChild(a)},isPartiallySelectedSubtree:function(){return b(this._current,this.range)},getSubtreeIterator:function(){var b;if(this.isSingleCharacterDataNode)b=this.range.cloneRange(),b.collapse();else{b=new E(a(this.range));var d=this._current,f=d,e=0,u=d,g=m.getNodeLength(d);if(m.isAncestorOf(d,this.sc,!0))f=this.sc,e=this.so;if(m.isAncestorOf(d,this.ec,!0))u=this.ec,g=this.eo;N(b,f,e,u,g)}return new i(b,this.clonePartiallySelectedTextNodes)},
detach:function(a){a&&this.range.detach();this.range=this._current=this._next=this._first=this._last=this.sc=this.so=this.ec=this.eo=null}};t.prototype={BAD_BOUNDARYPOINTS_ERR:1,INVALID_NODE_TYPE_ERR:2};t.prototype.toString=function(){return this.message};k.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){this._current=this._next;this._next=this.nodes[++this._position];return this._current},detach:function(){this._current=this._next=this.nodes=null}};var O=[1,3,4,5,
7,8,10],J=[2,9,11],Q=[1,3,4,5,7,8,10,11],M=[1,3,4,5,7,8],u=m.getRootContainer,L=p([9,11]),$=p([5,6,10,12]),Z=p([6,10,12]),T=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],R=0,U=1,aa=2,V=3,W=0,X=1,Y=2,S=3;H.prototype={attachListener:function(a,b){this._listeners[a].push(b)},compareBoundaryPoints:function(a,b){w(this);C(this.startContainer,b.startContainer);var d=a==V||a==R?"start":"end",f=a==U||a==R?"start":"end";return m.comparePoints(this[d+"Container"],
this[d+"Offset"],b[f+"Container"],b[f+"Offset"])},insertNode:function(a){w(this);x(a,Q);A(this.startContainer);if(m.isAncestorOf(a,this.startContainer,!0))throw new D("HIERARCHY_REQUEST_ERR");this.setStartBefore(h(a,this.startContainer,this.startOffset))},cloneContents:function(){w(this);var b,d;if(this.collapsed)return a(this).createDocumentFragment();else{if(this.startContainer===this.endContainer&&m.isCharacterDataNode(this.startContainer))return b=this.startContainer.cloneNode(!0),b.data=b.data.slice(this.startOffset,
this.endOffset),d=a(this).createDocumentFragment(),d.appendChild(b),d;else d=new i(this,!0),b=j(d),d.detach();return b}},canSurroundContents:function(){w(this);A(this.startContainer);A(this.endContainer);var a=new i(this,!0),d=a._first&&b(a._first,this)||a._last&&b(a._last,this);a.detach();return!d},surroundContents:function(a){x(a,M);if(!this.canSurroundContents())throw new t("BAD_BOUNDARYPOINTS_ERR");var b=this.extractContents();if(a.hasChildNodes())for(;a.lastChild;)a.removeChild(a.lastChild);
h(a,this.startContainer,this.startOffset);a.appendChild(b);this.selectNode(a)},cloneRange:function(){w(this);for(var b=new E(a(this)),d=T.length,f;d--;)f=T[d],b[f]=this[f];return b},toString:function(){w(this);var a=this.startContainer;if(a===this.endContainer&&m.isCharacterDataNode(a))return a.nodeType==3||a.nodeType==4?a.data.slice(this.startOffset,this.endOffset):"";else{var b=[],a=new i(this,!0);l(a,function(a){(a.nodeType==3||a.nodeType==4)&&b.push(a.data)});a.detach();return b.join("")}},compareNode:function(a){w(this);
var b=a.parentNode,d=m.getNodeIndex(a);if(!b)throw new D("NOT_FOUND_ERR");a=this.comparePoint(b,d);b=this.comparePoint(b,d+1);return a<0?b>0?Y:W:b>0?X:S},comparePoint:function(a,b){w(this);z(a,"HIERARCHY_REQUEST_ERR");C(a,this.startContainer);if(m.comparePoints(a,b,this.startContainer,this.startOffset)<0)return-1;else if(m.comparePoints(a,b,this.endContainer,this.endOffset)>0)return 1;return 0},createContextualFragment:function(b){q(this);var d=a(this),f=d.createElement("div");f.innerHTML=b;for(b=
d.createDocumentFragment();d=f.firstChild;)b.appendChild(d);return b},toHtml:function(){w(this);var b=a(this).createElement("div");b.appendChild(this.cloneContents());return b.innerHTML},intersectsNode:function(b,d){w(this);z(b,"NOT_FOUND_ERR");if(m.getDocument(b)!==a(this))return!1;var f=b.parentNode,e=m.getNodeIndex(b);z(f,"NOT_FOUND_ERR");var u=m.comparePoints(f,e,this.endContainer,this.endOffset),f=m.comparePoints(f,e+1,this.startContainer,this.startOffset);return d?u<=0&&f>=0:u<0&&f>0},isPointInRange:function(a,
b){w(this);z(a,"HIERARCHY_REQUEST_ERR");C(a,this.startContainer);return m.comparePoints(a,b,this.startContainer,this.startOffset)>=0&&m.comparePoints(a,b,this.endContainer,this.endOffset)<=0},intersectsRange:function(b,d){w(this);if(a(b)!=a(this))throw new D("WRONG_DOCUMENT_ERR");var f=m.comparePoints(this.startContainer,this.startOffset,b.endContainer,b.endOffset),e=m.comparePoints(this.endContainer,this.endOffset,b.startContainer,b.startOffset);return d?f<=0&&e>=0:f<0&&e>0},intersection:function(a){if(this.intersectsRange(a)){var b=
m.comparePoints(this.startContainer,this.startOffset,a.startContainer,a.startOffset),d=m.comparePoints(this.endContainer,this.endOffset,a.endContainer,a.endOffset),f=this.cloneRange();b==-1&&f.setStart(a.startContainer,a.startOffset);d==1&&f.setEnd(a.endContainer,a.endOffset);return f}return null},union:function(a){if(this.intersectsRange(a,!0)){var b=this.cloneRange();m.comparePoints(a.startContainer,a.startOffset,this.startContainer,this.startOffset)==-1&&b.setStart(a.startContainer,a.startOffset);
m.comparePoints(a.endContainer,a.endOffset,this.endContainer,this.endOffset)==1&&b.setEnd(a.endContainer,a.endOffset);return b}else throw new t("Ranges do not intersect");},containsNode:function(a,b){return b?this.intersectsNode(a,!1):this.compareNode(a)==S},containsNodeContents:function(a){return this.comparePoint(a,0)>=0&&this.comparePoint(a,m.getNodeLength(a))<=0},containsRange:function(a){return this.intersection(a).equals(a)},containsNodeText:function(a){var b=this.cloneRange();b.selectNode(a);
var d=b.getNodes([3]);return d.length>0?(b.setStart(d[0],0),a=d.pop(),b.setEnd(a,a.length),a=this.containsRange(b),b.detach(),a):this.containsNodeContents(a)},createNodeIterator:function(a,b){w(this);return new k(this,a,b)},getNodes:function(a,b){w(this);return s(this,a,b)},getDocument:function(){return a(this)},collapseBefore:function(a){q(this);this.setEndBefore(a);this.collapse(!1)},collapseAfter:function(a){q(this);this.setStartAfter(a);this.collapse(!0)},getName:function(){return"DomRange"},
equals:function(a){return E.rangesEqual(this,a)},inspect:function(){return o(this)}};B(E,N,function(a){q(a);a.startContainer=a.startOffset=a.endContainer=a.endOffset=null;a.collapsed=a.commonAncestorContainer=null;d(a,"detach",null);a._listeners=null});e.rangePrototype=H.prototype;E.rangeProperties=T;E.RangeIterator=i;E.copyComparisonConstants=I;E.createPrototypeRange=B;E.inspect=o;E.getRangeDocument=a;E.rangesEqual=function(a,b){return a.startContainer===b.startContainer&&a.startOffset===b.startOffset&&
a.endContainer===b.endContainer&&a.endOffset===b.endOffset};e.DomRange=E;e.RangeException=t});
rangy.createModule("WrappedRange",function(e){function b(a,b,d,e){var h=a.duplicate();h.collapse(d);var i=h.parentElement();f.isAncestorOf(b,i,!0)||(i=b);if(!i.canHaveHTML)return new g(i.parentNode,f.getNodeIndex(i));var b=f.getDocument(i).createElement("span"),t,k=d?"StartToStart":"StartToEnd";do i.insertBefore(b,b.previousSibling),h.moveToElementText(b);while((t=h.compareEndPoints(k,a))>0&&b.previousSibling);k=b.nextSibling;if(t==-1&&k&&f.isCharacterDataNode(k)){h.setEndPoint(d?"EndToStart":"EndToEnd",
a);if(/[\r\n]/.test(k.data)){i=h.duplicate();d=i.text.replace(/\r\n/g,"\r").length;for(d=i.moveStart("character",d);i.compareEndPoints("StartToEnd",i)==-1;)d++,i.moveStart("character",1)}else d=h.text.length;i=new g(k,d)}else k=(e||!d)&&b.previousSibling,i=(d=(e||d)&&b.nextSibling)&&f.isCharacterDataNode(d)?new g(d,0):k&&f.isCharacterDataNode(k)?new g(k,k.length):new g(i,f.getNodeIndex(b));b.parentNode.removeChild(b);return i}function a(a,b){var d,e,g=a.offset,i=f.getDocument(a.node),h=i.body.createTextRange(),
k=f.isCharacterDataNode(a.node);k?(d=a.node,e=d.parentNode):(d=a.node.childNodes,d=g<d.length?d[g]:null,e=a.node);i=i.createElement("span");i.innerHTML="&#feff;";d?e.insertBefore(i,d):e.appendChild(i);h.moveToElementText(i);h.collapse(!b);e.removeChild(i);if(k)h[b?"moveStart":"moveEnd"]("character",g);return h}e.requireModules(["DomUtil","DomRange"]);var d,f=e.dom,g=f.DomPosition,h=e.DomRange;if(e.features.implementsDomRange&&(!e.features.implementsTextRange||!e.config.preferTextRange))(function(){function a(b){for(var d=
e.length,f;d--;)f=e[d],b[f]=b.nativeRange[f]}var b,e=h.rangeProperties,g;d=function(b){if(!b)throw Error("Range must be specified");this.nativeRange=b;a(this)};h.createPrototypeRange(d,function(a,b,d,f,e){var g=a.endContainer!==f||a.endOffset!=e;if(a.startContainer!==b||a.startOffset!=d||g)a.setEnd(f,e),a.setStart(b,d)},function(a){a.nativeRange.detach();a.detached=!0;for(var b=e.length,d;b--;)d=e[b],a[d]=null});b=d.prototype;b.selectNode=function(b){this.nativeRange.selectNode(b);a(this)};b.deleteContents=
function(){this.nativeRange.deleteContents();a(this)};b.extractContents=function(){var b=this.nativeRange.extractContents();a(this);return b};b.cloneContents=function(){return this.nativeRange.cloneContents()};b.surroundContents=function(b){this.nativeRange.surroundContents(b);a(this)};b.collapse=function(b){this.nativeRange.collapse(b);a(this)};b.cloneRange=function(){return new d(this.nativeRange.cloneRange())};b.refresh=function(){a(this)};b.toString=function(){return this.nativeRange.toString()};
var j=document.createTextNode("test");f.getBody(document).appendChild(j);var i=document.createRange();i.setStart(j,0);i.setEnd(j,0);try{i.setStart(j,1),b.setStart=function(b,d){this.nativeRange.setStart(b,d);a(this)},b.setEnd=function(b,d){this.nativeRange.setEnd(b,d);a(this)},g=function(b){return function(d){this.nativeRange[b](d);a(this)}}}catch(t){b.setStart=function(b,d){try{this.nativeRange.setStart(b,d)}catch(f){this.nativeRange.setEnd(b,d),this.nativeRange.setStart(b,d)}a(this)},b.setEnd=function(b,
d){try{this.nativeRange.setEnd(b,d)}catch(f){this.nativeRange.setStart(b,d),this.nativeRange.setEnd(b,d)}a(this)},g=function(b,d){return function(f){try{this.nativeRange[b](f)}catch(e){this.nativeRange[d](f),this.nativeRange[b](f)}a(this)}}}b.setStartBefore=g("setStartBefore","setEndBefore");b.setStartAfter=g("setStartAfter","setEndAfter");b.setEndBefore=g("setEndBefore","setStartBefore");b.setEndAfter=g("setEndAfter","setStartAfter");i.selectNodeContents(j);b.selectNodeContents=i.startContainer==
j&&i.endContainer==j&&i.startOffset==0&&i.endOffset==j.length?function(b){this.nativeRange.selectNodeContents(b);a(this)}:function(a){this.setStart(a,0);this.setEnd(a,h.getEndOffset(a))};i.selectNodeContents(j);i.setEnd(j,3);g=document.createRange();g.selectNodeContents(j);g.setEnd(j,4);g.setStart(j,2);b.compareBoundaryPoints=i.compareBoundaryPoints(i.START_TO_END,g)==-1&i.compareBoundaryPoints(i.END_TO_START,g)==1?function(a,b){b=b.nativeRange||b;if(a==b.START_TO_END)a=b.END_TO_START;else if(a==
b.END_TO_START)a=b.START_TO_END;return this.nativeRange.compareBoundaryPoints(a,b)}:function(a,b){return this.nativeRange.compareBoundaryPoints(a,b.nativeRange||b)};f.getBody(document).removeChild(j);i.detach();g.detach()})(),e.createNativeRange=function(a){return(a||document).createRange()};else if(e.features.implementsTextRange){d=function(a){this.textRange=a;this.refresh()};d.prototype=new h(document);d.prototype.refresh=function(){var a,d,e=this.textRange;a=e.parentElement();var g=e.duplicate();
g.collapse(!0);d=g.parentElement();g=e.duplicate();g.collapse(!1);e=g.parentElement();d=d==e?d:f.getCommonAncestor(d,e);d=d==a?d:f.getCommonAncestor(a,d);this.textRange.compareEndPoints("StartToEnd",this.textRange)==0?d=a=b(this.textRange,d,!0,!0):(a=b(this.textRange,d,!0,!1),d=b(this.textRange,d,!1,!1));this.setStart(a.node,a.offset);this.setEnd(d.node,d.offset)};h.copyComparisonConstants(d);var j=function(){return this}();if(typeof j.Range=="undefined")j.Range=d;e.createNativeRange=function(a){return(a||
document).body.createTextRange()}}if(e.features.implementsTextRange)d.rangeToTextRange=function(b){if(b.collapsed)return a(new g(b.startContainer,b.startOffset),!0);else{var d=a(new g(b.startContainer,b.startOffset),!0),e=a(new g(b.endContainer,b.endOffset),!1),b=f.getDocument(b.startContainer).body.createTextRange();b.setEndPoint("StartToStart",d);b.setEndPoint("EndToEnd",e);return b}};d.prototype.getName=function(){return"WrappedRange"};e.WrappedRange=d;e.createRange=function(a){return new d(e.createNativeRange(a||
document))};e.createRangyRange=function(a){return new h(a||document)};e.createIframeRange=function(a){return e.createRange(f.getIframeDocument(a))};e.createIframeRangyRange=function(a){return e.createRangyRange(f.getIframeDocument(a))};e.addCreateMissingNativeApiListener(function(a){a=a.document;if(typeof a.createRange=="undefined")a.createRange=function(){return e.createRange(this)};a=a=null})});
rangy.createModule("WrappedSelection",function(e,b){function a(a){return(a||window).getSelection()}function d(a){return(a||window).document.selection}function f(a,b,d){var f=d?"end":"start",d=d?"start":"end";a.anchorNode=b[f+"Container"];a.anchorOffset=b[f+"Offset"];a.focusNode=b[d+"Container"];a.focusOffset=b[d+"Offset"]}function g(a){a.anchorNode=a.focusNode=null;a.anchorOffset=a.focusOffset=0;a.rangeCount=0;a.isCollapsed=!0;a._ranges.length=0}function h(a){var b;if(a instanceof y){if(b=a._selectionNativeRange,
!b)b=e.createNativeRange(k.getDocument(a.startContainer)),b.setEnd(a.endContainer,a.endOffset),b.setStart(a.startContainer,a.startOffset),a._selectionNativeRange=b,a.attachListener("detach",function(){this._selectionNativeRange=null})}else a instanceof q?b=a.nativeRange:e.features.implementsDomRange&&a instanceof k.getWindow(a.startContainer).Range&&(b=a);return b}function j(a){var b=a.getNodes(),d;a:if(!b.length||b[0].nodeType!=1)d=!1;else{d=1;for(var f=b.length;d<f;++d)if(!k.isAncestorOf(b[0],b[d])){d=
!1;break a}d=!0}if(!d)throw Error("getSingleElementFromRange: range "+a.inspect()+" did not consist of a single element");return b[0]}function l(a,b){var d=new q(b);a._ranges=[d];f(a,d,!1);a.rangeCount=1;a.isCollapsed=d.collapsed}function r(a){a._ranges.length=0;if(a.docSelection.type=="None")g(a);else{var b=a.docSelection.createRange();if(b&&typeof b.text!="undefined")l(a,b);else{a.rangeCount=b.length;for(var d,B=k.getDocument(b.item(0)),i=0;i<a.rangeCount;++i)d=e.createRange(B),d.selectNode(b.item(i)),
a._ranges.push(d);a.isCollapsed=a.rangeCount==1&&a._ranges[0].collapsed;f(a,a._ranges[a.rangeCount-1],!1)}}}function n(a,b){for(var d=a.docSelection.createRange(),f=j(b),e=k.getDocument(d.item(0)),e=k.getBody(e).createControlRange(),g=0,B=d.length;g<B;++g)e.add(d.item(g));try{e.add(f)}catch(i){throw Error("addRange(): Element within the specified Range could not be added to control selection (does it have layout?)");}e.select();r(a)}function s(a,b,d){this.nativeSelection=a;this.docSelection=b;this._ranges=
[];this.win=d;this.refresh()}function o(a,b){for(var d=k.getDocument(b[0].startContainer),d=k.getBody(d).createControlRange(),f=0,e;f<rangeCount;++f){e=j(b[f]);try{d.add(e)}catch(g){throw Error("setRanges(): Element within the one of the specified Ranges could not be added to control selection (does it have layout?)");}}d.select();r(a)}function i(a,b){if(a.anchorNode&&k.getDocument(a.anchorNode)!==k.getDocument(b))throw new x("WRONG_DOCUMENT_ERR");}function t(a){var b=[],d=new F(a.anchorNode,a.anchorOffset),
f=new F(a.focusNode,a.focusOffset),e=typeof a.getName=="function"?a.getName():"Selection";if(typeof a.rangeCount!="undefined")for(var g=0,B=a.rangeCount;g<B;++g)b[g]=y.inspect(a.getRangeAt(g));return"["+e+"(Ranges: "+b.join(", ")+")(anchor: "+d.inspect()+", focus: "+f.inspect()+"]"}e.requireModules(["DomUtil","DomRange","WrappedRange"]);e.config.checkSelectionRanges=!0;var k=e.dom,p=e.util,y=e.DomRange,q=e.WrappedRange,x=e.DOMException,F=k.DomPosition,C,A,z=e.util.isHostMethod(window,"getSelection"),
w=e.util.isHostObject(document,"selection"),H=w&&(!z||e.config.preferTextRange);H?(C=d,e.isSelectionValid=function(a){var a=(a||window).document,b=a.selection;return b.type!="None"||k.getDocument(b.createRange().parentElement())==a}):z?(C=a,e.isSelectionValid=function(){return!0}):b.fail("Neither document.selection or window.getSelection() detected.");e.getNativeSelection=C;var z=C(),K=e.createNativeRange(document),I=k.getBody(document),G=p.areHostObjects(z,p.areHostProperties(z,["anchorOffset","focusOffset"]));
e.features.selectionHasAnchorAndFocus=G;var B=p.isHostMethod(z,"extend");e.features.selectionHasExtend=B;var P=typeof z.rangeCount=="number";e.features.selectionHasRangeCount=P;var N=!1,E=!0;p.areHostMethods(z,["addRange","getRangeAt","removeAllRanges"])&&typeof z.rangeCount=="number"&&e.features.implementsDomRange&&function(){var a=document.createElement("iframe");I.appendChild(a);var b=k.getIframeDocument(a);b.open();b.write("<html><head></head><body>12</body></html>");b.close();var d=k.getIframeWindow(a).getSelection(),
f=b.documentElement.lastChild.firstChild,b=b.createRange();b.setStart(f,1);b.collapse(!0);d.addRange(b);E=d.rangeCount==1;d.removeAllRanges();var e=b.cloneRange();b.setStart(f,0);e.setEnd(f,2);d.addRange(b);d.addRange(e);N=d.rangeCount==2;b.detach();e.detach();I.removeChild(a)}();e.features.selectionSupportsMultipleRanges=N;e.features.collapsedNonEditableSelectionsSupported=E;var m=!1,v;I&&p.isHostMethod(I,"createControlRange")&&(v=I.createControlRange(),p.areHostProperties(v,["item","add"])&&(m=
!0));e.features.implementsControlRange=m;A=G?function(a){return a.anchorNode===a.focusNode&&a.anchorOffset===a.focusOffset}:function(a){return a.rangeCount?a.getRangeAt(a.rangeCount-1).collapsed:!1};var D;p.isHostMethod(z,"getRangeAt")?D=function(a,b){try{return a.getRangeAt(b)}catch(d){return null}}:G&&(D=function(a){var b=k.getDocument(a.anchorNode),b=e.createRange(b);b.setStart(a.anchorNode,a.anchorOffset);b.setEnd(a.focusNode,a.focusOffset);b.collapsed!==this.isCollapsed&&(b.setStart(a.focusNode,
a.focusOffset),b.setEnd(a.anchorNode,a.anchorOffset));return b});e.getSelection=function(a){var a=a||window,b=a._rangySelection,f=C(a),e=w?d(a):null;b?(b.nativeSelection=f,b.docSelection=e,b.refresh(a)):(b=new s(f,e,a),a._rangySelection=b);return b};e.getIframeSelection=function(a){return e.getSelection(k.getIframeWindow(a))};v=s.prototype;if(!H&&G&&p.areHostMethods(z,["removeAllRanges","addRange"])){v.removeAllRanges=function(){this.nativeSelection.removeAllRanges();g(this)};var O=function(a,b){var d=
y.getRangeDocument(b),d=e.createRange(d);d.collapseToPoint(b.endContainer,b.endOffset);a.nativeSelection.addRange(h(d));a.nativeSelection.extend(b.startContainer,b.startOffset);a.refresh()};v.addRange=P?function(a,b){if(m&&w&&this.docSelection.type=="Control")n(this,a);else if(b&&B)O(this,a);else{var d;N?d=this.rangeCount:(this.removeAllRanges(),d=0);this.nativeSelection.addRange(h(a));this.rangeCount=this.nativeSelection.rangeCount;this.rangeCount==d+1?(e.config.checkSelectionRanges&&(d=D(this.nativeSelection,
this.rangeCount-1))&&!y.rangesEqual(d,a)&&(a=new q(d)),this._ranges[this.rangeCount-1]=a,f(this,a,M(this.nativeSelection)),this.isCollapsed=A(this)):this.refresh()}}:function(a,b){b&&B?O(this,a):(this.nativeSelection.addRange(h(a)),this.refresh())};v.setRanges=function(a){if(m&&a.length>1)o(this,a);else{this.removeAllRanges();for(var b=0,d=a.length;b<d;++b)this.addRange(a[b])}}}else if(p.isHostMethod(z,"empty")&&p.isHostMethod(K,"select")&&m&&H)v.removeAllRanges=function(){try{if(this.docSelection.empty(),
this.docSelection.type!="None"){var a;if(this.anchorNode)a=k.getDocument(this.anchorNode);else if(this.docSelection.type=="Control"){var b=this.docSelection.createRange();b.length&&(a=k.getDocument(b.item(0)).body.createTextRange())}a&&(a.body.createTextRange().select(),this.docSelection.empty())}}catch(d){}g(this)},v.addRange=function(a){this.docSelection.type=="Control"?n(this,a):(q.rangeToTextRange(a).select(),this._ranges[0]=a,this.rangeCount=1,this.isCollapsed=this._ranges[0].collapsed,f(this,
a,!1))},v.setRanges=function(a){this.removeAllRanges();var b=a.length;b>1?o(this,a):b&&this.addRange(a[0])};else return b.fail("No means of selecting a Range or TextRange was found"),!1;v.getRangeAt=function(a){if(a<0||a>=this.rangeCount)throw new x("INDEX_SIZE_ERR");else return this._ranges[a]};var J;if(H)J=function(a){var b;e.isSelectionValid(a.win)?b=a.docSelection.createRange():(b=k.getBody(a.win.document).createTextRange(),b.collapse(!0));a.docSelection.type=="Control"?r(a):b&&typeof b.text!=
"undefined"?l(a,b):g(a)};else if(p.isHostMethod(z,"getRangeAt")&&typeof z.rangeCount=="number")J=function(a){if(m&&w&&a.docSelection.type=="Control")r(a);else if(a._ranges.length=a.rangeCount=a.nativeSelection.rangeCount,a.rangeCount){for(var b=0,d=a.rangeCount;b<d;++b)a._ranges[b]=new e.WrappedRange(a.nativeSelection.getRangeAt(b));f(a,a._ranges[a.rangeCount-1],M(a.nativeSelection));a.isCollapsed=A(a)}else g(a)};else if(G&&typeof z.isCollapsed=="boolean"&&typeof K.collapsed=="boolean"&&e.features.implementsDomRange)J=
function(a){var b;b=a.nativeSelection;b.anchorNode?(b=D(b,0),a._ranges=[b],a.rangeCount=1,b=a.nativeSelection,a.anchorNode=b.anchorNode,a.anchorOffset=b.anchorOffset,a.focusNode=b.focusNode,a.focusOffset=b.focusOffset,a.isCollapsed=A(a)):g(a)};else return b.fail("No means of obtaining a Range or TextRange from the user's selection was found"),!1;v.refresh=function(a){var b=a?this._ranges.slice(0):null;J(this);if(a){a=b.length;if(a!=this._ranges.length)return!1;for(;a--;)if(!y.rangesEqual(b[a],this._ranges[a]))return!1;
return!0}};var Q=function(a,b){var d=a.getAllRanges(),f=!1;a.removeAllRanges();for(var e=0,B=d.length;e<B;++e)f||b!==d[e]?a.addRange(d[e]):f=!0;a.rangeCount||g(a)};v.removeRange=m?function(a){if(this.docSelection.type=="Control"){for(var b=this.docSelection.createRange(),a=j(a),d=k.getDocument(b.item(0)),d=k.getBody(d).createControlRange(),f,e=!1,g=0,B=b.length;g<B;++g)f=b.item(g),f!==a||e?d.add(b.item(g)):e=!0;d.select();r(this)}else Q(this,a)}:function(a){Q(this,a)};var M;!H&&G&&e.features.implementsDomRange?
(M=function(a){var b=!1;a.anchorNode&&(b=k.comparePoints(a.anchorNode,a.anchorOffset,a.focusNode,a.focusOffset)==1);return b},v.isBackwards=function(){return M(this)}):M=v.isBackwards=function(){return!1};v.toString=function(){for(var a=[],b=0,d=this.rangeCount;b<d;++b)a[b]=""+this._ranges[b];return a.join("")};v.collapse=function(a,b){i(this,a);var d=e.createRange(k.getDocument(a));d.collapseToPoint(a,b);this.removeAllRanges();this.addRange(d);this.isCollapsed=!0};v.collapseToStart=function(){if(this.rangeCount){var a=
this._ranges[0];this.collapse(a.startContainer,a.startOffset)}else throw new x("INVALID_STATE_ERR");};v.collapseToEnd=function(){if(this.rangeCount){var a=this._ranges[this.rangeCount-1];this.collapse(a.endContainer,a.endOffset)}else throw new x("INVALID_STATE_ERR");};v.selectAllChildren=function(a){i(this,a);var b=e.createRange(k.getDocument(a));b.selectNodeContents(a);this.removeAllRanges();this.addRange(b)};v.deleteFromDocument=function(){if(m&&w&&this.docSelection.type=="Control"){for(var a=this.docSelection.createRange(),
b;a.length;)b=a.item(0),a.remove(b),b.parentNode.removeChild(b);this.refresh()}else if(this.rangeCount){a=this.getAllRanges();this.removeAllRanges();b=0;for(var d=a.length;b<d;++b)a[b].deleteContents();this.addRange(a[d-1])}};v.getAllRanges=function(){return this._ranges.slice(0)};v.setSingleRange=function(a){this.setRanges([a])};v.containsNode=function(a,b){for(var d=0,f=this._ranges.length;d<f;++d)if(this._ranges[d].containsNode(a,b))return!0;return!1};v.toHtml=function(){var a="";if(this.rangeCount){for(var a=
y.getRangeDocument(this._ranges[0]).createElement("div"),b=0,d=this._ranges.length;b<d;++b)a.appendChild(this._ranges[b].cloneContents());a=a.innerHTML}return a};v.getName=function(){return"WrappedSelection"};v.inspect=function(){return t(this)};v.detach=function(){this.win=this.anchorNode=this.focusNode=this.win._rangySelection=null};s.inspect=t;e.Selection=s;e.selectionPrototype=v;e.addCreateMissingNativeApiListener(function(a){if(typeof a.getSelection=="undefined")a.getSelection=function(){return e.getSelection(this)};
a=null})});
rangy.createModule("CssClassApplier",function(e,b){function a(a,b){return a.className&&RegExp("(?:^|\\s)"+b+"(?:\\s|$)").test(a.className)}function d(b,d){b.className?a(b,d)||(b.className+=" "+d):b.className=d}function f(a){return a.split(/\s+/).sort().join(" ")}function g(a,b){return f(a.className)==f(b.className)}function h(a){for(var b=a.parentNode;a.hasChildNodes();)b.insertBefore(a.firstChild,a);b.removeChild(a)}function j(a,b){var d=a.cloneRange();d.selectNodeContents(b);var f=d.intersection(a),f=
f?f.toString():"";d.detach();return f!=""}function l(a){return a.getNodes([3],function(b){return j(a,b)})}function r(a,b){if(a.attributes.length!=b.attributes.length)return!1;for(var d=0,f=a.attributes.length,e,g;d<f;++d)if(e=a.attributes[d],g=e.name,g!="class"){g=b.attributes.getNamedItem(g);if(e.specified!=g.specified)return!1;if(e.specified&&e.nodeValue!==g.nodeValue)return!1}return!0}function n(a,b){for(var d=0,f=a.attributes.length,e;d<f;++d)if(e=a.attributes[d].name,(!b||!x.arrayContains(b,
e))&&a.attributes[d].specified&&e!="class")return!0;return!1}function s(a){var b;return a&&a.nodeType==1&&((b=a.parentNode)&&b.nodeType==9&&b.designMode=="on"||A(a)&&!A(a.parentNode))}function o(a){return(A(a)||a.nodeType!=1&&A(a.parentNode))&&!s(a)}function i(a){return a&&a.nodeType==1&&!z.test(C(a,"display"))}function t(a){if(a.data.length==0)return!0;if(w.test(a.data))return!1;switch(C(a.parentNode,"whiteSpace")){case "pre":case "pre-wrap":case "-moz-pre-wrap":return!1;case "pre-line":if(/[\r\n]/.test(a.data))return!1}return i(a.previousSibling)||
i(a.nextSibling)}function k(a,d,f,e){var g,i=f==0;if(x.isAncestorOf(d,a))throw b.createError("descendant is ancestor of node");if(x.isCharacterDataNode(d))if(f==0)f=x.getNodeIndex(d),d=d.parentNode;else if(f==d.length)f=x.getNodeIndex(d)+1,d=d.parentNode;else throw b.createError("splitNodeAt should not be called with offset in the middle of a data node ("+f+" in "+d.data);if(x.isCharacterDataNode(d)?f==0?d.previousSibling:f==d.length?d.nextSibling:1:f>0&&f<d.childNodes.length){if(!g){g=d.cloneNode(!1);
for(g.id&&g.removeAttribute("id");i=d.childNodes[f];)g.appendChild(i);x.insertAfter(g,d)}return d==a?g:k(a,g.parentNode,x.getNodeIndex(g),e)}else if(a!=d)return g=d.parentNode,d=x.getNodeIndex(d),i||d++,k(a,g,d,e);return a}function p(a){var b=a?"nextSibling":"previousSibling";return function(d,f){var e=d.parentNode,i=d[b];if(i){if(i&&i.nodeType==3)return i}else if(f&&(i=e[b])&&i.nodeType==1&&e.tagName==i.tagName&&g(e,i)&&r(e,i))return i[a?"firstChild":"lastChild"];return null}}function y(a){this.firstTextNode=
(this.isElementMerge=a.nodeType==1)?a.lastChild:a;this.textNodes=[this.firstTextNode]}function q(a,b,d){this.cssClass=a;var e,g,i=null;if(typeof b=="object"&&b!==null){d=b.tagNames;i=b.elementProperties;for(e=0;g=I[e++];)b.hasOwnProperty(g)&&(this[g]=b[g]);e=b.normalize}else e=b;this.normalize=typeof e=="undefined"?!0:e;this.attrExceptions=[];e=document.createElement(this.elementTagName);this.elementProperties={};for(var h in i)i.hasOwnProperty(h)&&(G.hasOwnProperty(h)&&(h=G[h]),e[h]=i[h],this.elementProperties[h]=
e[h],this.attrExceptions.push(h));this.elementSortedClassName=this.elementProperties.hasOwnProperty("className")?f(this.elementProperties.className+" "+a):a;this.applyToAnyTagName=!1;a=typeof d;if(a=="string")d=="*"?this.applyToAnyTagName=!0:this.tagNames=d.toLowerCase().replace(/^\s\s*/,"").replace(/\s\s*$/,"").split(/\s*,\s*/);else if(a=="object"&&typeof d.length=="number"){this.tagNames=[];e=0;for(a=d.length;e<a;++e)d[e]=="*"?this.applyToAnyTagName=!0:this.tagNames.push(d[e].toLowerCase())}else this.tagNames=
[this.elementTagName]}e.requireModules(["WrappedSelection","WrappedRange"]);var x=e.dom,F=function(){function a(b,d,f){return d&&f?" ":""}return function(b,d){if(b.className)b.className=b.className.replace(RegExp("(?:^|\\s)"+d+"(?:\\s|$)"),a)}}(),C;typeof window.getComputedStyle!="undefined"?C=function(a,b){return x.getWindow(a).getComputedStyle(a,null)[b]}:typeof document.documentElement.currentStyle!="undefined"?C=function(a,b){return a.currentStyle[b]}:b.fail("No means of obtaining computed style properties found");
var A;(function(){A=typeof document.createElement("div").isContentEditable=="boolean"?function(a){return a&&a.nodeType==1&&a.isContentEditable}:function(a){return!a||a.nodeType!=1||a.contentEditable=="false"?!1:a.contentEditable=="true"||A(a.parentNode)}})();var z=/^inline(-block|-table)?$/i,w=/[^\r\n\t\f \u200B]/,H=p(!1),K=p(!0);y.prototype={doMerge:function(){for(var a=[],b,d,f=0,e=this.textNodes.length;f<e;++f)b=this.textNodes[f],d=b.parentNode,a[f]=b.data,f&&(d.removeChild(b),d.hasChildNodes()||
d.parentNode.removeChild(d));return this.firstTextNode.data=a=a.join("")},getLength:function(){for(var a=this.textNodes.length,b=0;a--;)b+=this.textNodes[a].length;return b},toString:function(){for(var a=[],b=0,d=this.textNodes.length;b<d;++b)a[b]="'"+this.textNodes[b].data+"'";return"[Merge("+a.join(",")+")]"}};var I=["elementTagName","ignoreWhiteSpace","applyToEditableOnly"],G={"class":"className"};q.prototype={elementTagName:"span",elementProperties:{},ignoreWhiteSpace:!0,applyToEditableOnly:!1,
hasClass:function(b){return b.nodeType==1&&x.arrayContains(this.tagNames,b.tagName.toLowerCase())&&a(b,this.cssClass)},getSelfOrAncestorWithClass:function(a){for(;a;){if(this.hasClass(a,this.cssClass))return a;a=a.parentNode}return null},isModifiable:function(a){return!this.applyToEditableOnly||o(a)},isIgnorableWhiteSpaceNode:function(a){return this.ignoreWhiteSpace&&a&&a.nodeType==3&&t(a)},postApply:function(a,b,d){for(var f=a[0],e=a[a.length-1],g=[],i,h=f,k=e,j=0,l=e.length,t,n,p=0,q=a.length;p<
q;++p)if(t=a[p],n=H(t,!d)){i||(i=new y(n),g.push(i));i.textNodes.push(t);if(t===f)h=i.firstTextNode,j=h.length;if(t===e)k=i.firstTextNode,l=i.getLength()}else i=null;if(a=K(e,!d))i||(i=new y(e),g.push(i)),i.textNodes.push(a);if(g.length){p=0;for(q=g.length;p<q;++p)g[p].doMerge();b.setStart(h,j);b.setEnd(k,l)}},createContainer:function(a){a=a.createElement(this.elementTagName);e.util.extend(a,this.elementProperties);d(a,this.cssClass);return a},applyToTextNode:function(a){var b=a.parentNode;b.childNodes.length==
1&&x.arrayContains(this.tagNames,b.tagName.toLowerCase())?d(b,this.cssClass):(b=this.createContainer(x.getDocument(a)),a.parentNode.insertBefore(b,a),b.appendChild(a))},isRemovable:function(a){var b;if(b=a.tagName.toLowerCase()==this.elementTagName)if(b=f(a.className)==this.elementSortedClassName){var d;a:{b=this.elementProperties;for(d in b)if(b.hasOwnProperty(d)&&a[d]!==b[d]){d=!1;break a}d=!0}b=d&&!n(a,this.attrExceptions)&&this.isModifiable(a)}return b},undoToTextNode:function(a,b,d){b.containsNode(d)||
(a=b.cloneRange(),a.selectNode(d),a.isPointInRange(b.endContainer,b.endOffset)&&(k(d,b.endContainer,b.endOffset,[b]),b.setEndAfter(d)),a.isPointInRange(b.startContainer,b.startOffset)&&(d=k(d,b.startContainer,b.startOffset,[b])));this.isRemovable(d)?h(d):F(d,this.cssClass)},applyToRange:function(a){a.splitBoundaries();var b=l(a);if(b.length){for(var d,f=0,e=b.length;f<e;++f)d=b[f],!this.isIgnorableWhiteSpaceNode(d)&&!this.getSelfOrAncestorWithClass(d)&&this.isModifiable(d)&&this.applyToTextNode(d);
a.setStart(b[0],0);d=b[b.length-1];a.setEnd(d,d.length);this.normalize&&this.postApply(b,a,!1)}},applyToSelection:function(a){var a=e.getSelection(a||window),b,d=a.getAllRanges();a.removeAllRanges();for(var f=d.length;f--;)b=d[f],this.applyToRange(b),a.addRange(b)},undoToRange:function(a){a.splitBoundaries();var b=l(a),d,f,e=b[b.length-1];if(b.length){for(var g=0,i=b.length;g<i;++g)d=b[g],(f=this.getSelfOrAncestorWithClass(d))&&this.isModifiable(d)&&this.undoToTextNode(d,a,f),a.setStart(b[0],0),a.setEnd(e,
e.length);this.normalize&&this.postApply(b,a,!0)}},undoToSelection:function(a){var a=e.getSelection(a||window),b=a.getAllRanges(),d;a.removeAllRanges();for(var f=0,g=b.length;f<g;++f)d=b[f],this.undoToRange(d),a.addRange(d)},getTextSelectedByRange:function(a,b){var d=b.cloneRange();d.selectNodeContents(a);var f=d.intersection(b),f=f?f.toString():"";d.detach();return f},isAppliedToRange:function(a){if(a.collapsed)return!!this.getSelfOrAncestorWithClass(a.commonAncestorContainer);else{for(var b=a.getNodes([3]),
d=0,f;f=b[d++];)if(!this.isIgnorableWhiteSpaceNode(f)&&j(a,f)&&this.isModifiable(f)&&!this.getSelfOrAncestorWithClass(f))return!1;return!0}},isAppliedToSelection:function(a){for(var a=e.getSelection(a||window).getAllRanges(),b=a.length;b--;)if(!this.isAppliedToRange(a[b]))return!1;return!0},toggleRange:function(a){this.isAppliedToRange(a)?this.undoToRange(a):this.applyToRange(a)},toggleSelection:function(a){this.isAppliedToSelection(a)?this.undoToSelection(a):this.applyToSelection(a)},detach:function(){}};
q.util={hasClass:a,addClass:d,removeClass:F,hasSameClasses:g,replaceWithOwnChildren:h,elementsHaveSameNonClassAttributes:r,elementHasNonClassAttributes:n,splitNodeAt:k,isEditableElement:A,isEditingHost:s,isEditable:o};e.CssClassApplier=q;e.createCssClassApplier=function(a,b,d){return new q(a,b,d)}});
rangy.createModule("SaveRestore",function(e,b){function a(a,b){var d="selectionBoundary_"+ +new Date+"_"+(""+Math.random()).slice(2),f,e=h.getDocument(a.startContainer),g=a.cloneRange();g.collapse(b);f=e.createElement("span");f.id=d;f.style.lineHeight="0";f.style.display="none";f.className="rangySelectionBoundary";f.appendChild(e.createTextNode(j));g.insertNode(f);g.detach();return f}function d(a,d,f,e){(a=(a||document).getElementById(f))?(d[e?"setStartBefore":"setEndBefore"](a),a.parentNode.removeChild(a)):
b.warn("Marker element has been removed. Cannot restore selection.")}function f(a,b){return b.compareBoundaryPoints(a.START_TO_START,a)}function g(a,b){var d=(a||document).getElementById(b);d&&d.parentNode.removeChild(d)}e.requireModules(["DomUtil","DomRange","WrappedRange"]);var h=e.dom,j="\ufeff";e.saveSelection=function(d){var d=d||window,g=d.document;if(e.isSelectionValid(d)){var h=e.getSelection(d),j=h.getAllRanges(),o=[],i,t;j.sort(f);for(var k=0,p=j.length;k<p;++k)i=j[k],i.collapsed?(t=a(i,
!1),o.push({markerId:t.id,collapsed:!0})):(t=a(i,!1),i=a(i,!0),o[k]={startMarkerId:i.id,endMarkerId:t.id,collapsed:!1,backwards:j.length==1&&h.isBackwards()});for(k=p-1;k>=0;--k)i=j[k],i.collapsed?i.collapseBefore((g||document).getElementById(o[k].markerId)):(i.setEndBefore((g||document).getElementById(o[k].endMarkerId)),i.setStartAfter((g||document).getElementById(o[k].startMarkerId)));h.setRanges(j);return{win:d,doc:g,rangeInfos:o,restored:!1}}else b.warn("Cannot save selection. This usually happens when the selection is collapsed and the selection document has lost focus.")};
e.restoreSelection=function(a,f){if(!a.restored){for(var g=a.rangeInfos,h=e.getSelection(a.win),j=[],i=g.length,t=i-1,k,p;t>=0;--t){k=g[t];p=e.createRange(a.doc);if(k.collapsed)if(k=(a.doc||document).getElementById(k.markerId)){k.style.display="inline";var y=k.previousSibling;y&&y.nodeType==3?(k.parentNode.removeChild(k),p.collapseToPoint(y,y.length)):(p.collapseBefore(k),k.parentNode.removeChild(k))}else b.warn("Marker element has been removed. Cannot restore selection.");else d(a.doc,p,k.startMarkerId,
!0),d(a.doc,p,k.endMarkerId,!1);i==1&&p.normalizeBoundaries();j[t]=p}i==1&&f&&e.features.selectionHasExtend&&g[0].backwards?(h.removeAllRanges(),h.addRange(j[0],!0)):h.setRanges(j);a.restored=!0}};e.removeMarkerElement=g;e.removeMarkers=function(a){for(var b=a.rangeInfos,d=0,f=b.length,e;d<f;++d)e=b[d],e.collapsed?g(a.doc,e.markerId):(g(a.doc,e.startMarkerId),g(a.doc,e.endMarkerId))}});
rangy.createModule("Serializer",function(e,b){function a(b,d){var d=d||[],f=b.nodeType,e=b.childNodes,g=e.length,h=[f,b.nodeName,g].join(":"),j="",l="";switch(f){case 3:j=b.nodeValue.replace(/</g,"&lt;").replace(/>/g,"&gt;");break;case 8:j="<\!--"+b.nodeValue.replace(/</g,"&lt;").replace(/>/g,"&gt;")+"--\>";break;default:j="<"+h+">",l="</>"}j&&d.push(j);for(f=0;f<g;++f)a(e[f],d);l&&d.push(l);return d}function d(b){b=a(b).join("");return s(b).toString(16)}function f(a,b,d){for(var f=[],e=a,d=d||o.getDocument(a).documentElement;e&&
e!=d;)f.push(o.getNodeIndex(e,!0)),e=e.parentNode;return f.join("/")+":"+b}function g(a,d,f){d?f||o.getDocument(d):d=(f||document).documentElement;for(var a=a.split(":"),f=a[0]?a[0].split("/"):[],e=f.length,g;e--;)if(g=parseInt(f[e],10),g<d.childNodes.length)d=d.childNodes[parseInt(f[e],10)];else throw b.createError("deserializePosition failed: node "+o.inspectNode(d)+" has no child with index "+g+", "+e);return new o.DomPosition(d,parseInt(a[1],10))}function h(a,b,g){g=g||e.DomRange.getRangeDocument(a).documentElement;
if(!o.isAncestorOf(g,a.commonAncestorContainer,!0))throw Error("serializeRange: range is not wholly contained within specified root node");a=f(a.startContainer,a.startOffset,g)+","+f(a.endContainer,a.endOffset,g);b||(a+="{"+d(g)+"}");return a}function j(a,b,f){b?f=f||o.getDocument(b):(f=f||document,b=f.documentElement);var a=/^([^,]+),([^,\{]+)({([^}]+)})?$/.exec(a),h=a[4],j=d(b);if(h&&h!==d(b))throw Error("deserializeRange: checksums of serialized range root node ("+h+") and target root node ("+
j+") do not match");h=g(a[1],b,f);b=g(a[2],b,f);f=e.createRange(f);f.setStart(h.node,h.offset);f.setEnd(b.node,b.offset);return f}function l(a,b,f){b?f||o.getDocument(b):b=(f||document).documentElement;a=/^([^,]+),([^,]+)({([^}]+)})?$/.exec(a)[3];return!a||a===d(b)}function r(a,b,d){for(var a=a||e.getSelection(),a=a.getAllRanges(),f=[],g=0,j=a.length;g<j;++g)f[g]=h(a[g],b,d);return f.join("|")}function n(a,b,d){b?d=d||o.getWindow(b):(d=d||window,b=d.document.documentElement);for(var a=a.split("|"),
f=e.getSelection(d),g=[],h=0,l=a.length;h<l;++h)g[h]=j(a[h],b,d.document);f.setRanges(g);return f}e.requireModules(["WrappedSelection","WrappedRange"]);(typeof encodeURIComponent=="undefined"||typeof decodeURIComponent=="undefined")&&b.fail("Global object is missing encodeURIComponent and/or decodeURIComponent method");var s=function(){var a=null;return function(b){for(var d=[],f=0,e=b.length,g;f<e;++f)g=b.charCodeAt(f),g<128?d.push(g):g<2048?d.push(g>>6|192,g&63|128):d.push(g>>12|224,g>>6&63|128,
g&63|128);b=-1;if(!a){for(var f=[],e=0,h;e<256;++e){h=e;for(g=8;g--;)(h&1)==1?h=h>>>1^3988292384:h>>>=1;f[e]=h>>>0}a=f}f=a;e=0;for(g=d.length;e<g;++e)h=(b^d[e])&255,b=b>>>8^f[h];return(b^-1)>>>0}}(),o=e.dom;e.serializePosition=f;e.deserializePosition=g;e.serializeRange=h;e.deserializeRange=j;e.canDeserializeRange=l;e.serializeSelection=r;e.deserializeSelection=n;e.canDeserializeSelection=function(a,b,d){var f;b?f=d?d.document:o.getDocument(b):b=(d||window).document.documentElement;for(var a=a.split("|"),
d=0,e=a.length;d<e;++d)if(!l(a[d],b,f))return!1;return!0};e.restoreSelectionFromCookie=function(a){var a=a||window,b;a:{b=a.document.cookie.split(/[;,]/);for(var d=0,f=b.length,e;d<f;++d)if(e=b[d].split("="),e[0].replace(/^\s+/,"")=="rangySerializedSelection"&&(e=e[1])){b=decodeURIComponent(e.replace(/\s+$/,""));break a}b=null}b&&n(b,a.doc)};e.saveSelectionCookie=function(a,b){var a=a||window,b=typeof b=="object"?b:{},d=b.expires?";expires="+b.expires.toUTCString():"",f=b.path?";path="+b.path:"",
g=b.domain?";domain="+b.domain:"",h=b.secure?";secure":"",j=r(e.getSelection(a));a.document.cookie=encodeURIComponent("rangySerializedSelection")+"="+encodeURIComponent(j)+d+f+g+h};e.getElementChecksum=d});
(function(){var e,b;e={changeIdAttribute:"data-cid",userIdAttribute:"data-userid",userNameAttribute:"data-username",timeAttribute:"data-time",attrValuePrefix:"",blockEl:"p",stylePrefix:"cts",currentUser:{id:null,name:null},changeTypes:{insertType:{tag:"insert",alias:"ins",action:"Inserted"},deleteType:{tag:"delete",alias:"del",action:"Deleted"}},handleEvents:!1,contentEditable:!0,isTracking:!0,noTrack:".ice-no-track",avoid:".ice-avoid",cmsBlock:".cms"};b=function(a){a||(a={});if(!a.element)throw Error("`options.element` must be defined for ice construction.");
ice.dom.extend(!0,this,e,a);this.pluginsManager=new ice.IcePluginManager(this);a.plugins&&this.pluginsManager.usePlugins("ice-init",a.plugins)};b.prototype={_changes:{},_userStyles:{},_styles:{},_uniqueStyleIndex:0,_browserType:null,_batchChangeid:null,_uniqueIDIndex:1,_delBookmark:"tempdel",isPlaceHoldingDeletes:!1,startTracking:function(){this.element.setAttribute("contentEditable",this.contentEditable);if(this.handleEvents){var a=this;ice.dom.bind(a.element,"keyup keydown keypress mousedown mouseup",
function(b){return a.handleEvent(b)})}this.initializeEnvironment();this.initializeEditor();this.initializeRange();this.pluginsManager.fireEnabled(this.element);return this},initializeEnvironment:function(){this.env||(this.env={});this.env.element=this.element;this.env.document=this.element.ownerDocument;this.env.window=this.env.document.defaultView||this.env.document.parentWindow||window;this.env.frame=this.env.window.frameElement;this.env.selection=this.selection=new ice.Selection(this.env)},initializeRange:function(){var a=
this.selection.createRange();a.setStart(ice.dom.find(this.element,this.blockEl)[0],0);a.collapse(!0);this.selection.addRange(a);this.env.frame?this.env.frame.contentWindow.focus():this.element.focus()},initializeEditor:function(){var a=this,b=this.env.document.createElement("div");this.element.childNodes.length?(ice.dom.each(ice.dom.contents(this.element),function(a,f){ice.dom.isBlockElement(f)&&b.appendChild(f)}),b.innerHTML===""&&b.appendChild(ice.dom.create("<"+this.blockEl+" ><br/></"+this.blockEl+
">"))):b.appendChild(ice.dom.create("<"+this.blockEl+" ><br/></"+this.blockEl+">"));this.element.innerHTML=b.innerHTML;var f=this._getIceNodeClass("insertType"),e=this._getIceNodeClass("deleteType");ice.dom.each(ice.dom.find(this.element,"."+f+",."+e),function(b,d){for(var l=0,r="",n=d.className.split(" "),b=0;b<n.length;b++){var s=RegExp(a.stylePrefix+"-(\\d+)").exec(n[b]);s&&(l=s[1]);(s=RegExp("("+f+"|"+e+")").exec(n[b]))&&(r=a._getChangeTypeFromAlias(s[1]))}n=ice.dom.attr(d,a.userIdAttribute);
a.setUserStyle(n,Number(l));l=ice.dom.attr(d,a.changeIdAttribute);a._changes[l]={type:r,userid:n,username:ice.dom.attr(d,a.userNameAttribute),time:ice.dom.attr(d,a.timeAttribute)}})},enableChangeTracking:function(){this.isTracking=!0;this.pluginsManager.fireEnabled(this.element)},disableChangeTracking:function(){this.isTracking=!1;this.pluginsManager.fireDisabled(this.element)},setCurrentUser:function(a){this.currentUser=a},handleEvent:function(a){if(this.isTracking)if(a.type=="mouseup"){var b=this;
setTimeout(function(){b.mouseUp(a)},200)}else if(a.type=="mousedown")return this.mouseDown(a);else if(a.type=="keypress"){var f=this.keyPress(a);f||a.preventDefault();return f}else if(a.type=="keydown")return(f=this.keyDown(a))||a.preventDefault(),f;else a.type=="keyup"&&this.pluginsManager.fireCaretUpdated()},createIceNode:function(a,b){var f=this.env.document.createElement(this.changeTypes[a].tag);ice.dom.addClass(f,this._getIceNodeClass(a));f.appendChild(b?b:this.env.document.createTextNode(""));
this.addChange(this.changeTypes[a].alias,[f]);this.pluginsManager.fireNodeCreated(f,{action:this.changeTypes[a].action});return f},insert:function(a,b){b?this.selection.addRange(b):b=this.getCurrentRange();typeof a==="string"&&(a=document.createTextNode(a));if(!b.collapsed&&(this.deleteContents(),b=this.getCurrentRange(),b.startContainer===b.endContainer&&this.element===b.startContainer)){ice.dom.empty(this.element);var f=b.getLastSelectableChild(this.element);b.setStartAfter(f);b.collapse(!0)}this._moveRangeToValidTrackingPos(b);
f=this.startBatchChange();this._insertNode(a||document.createTextNode("\ufeff"),b,!a);this.pluginsManager.fireNodeInserted(a,b);this.endBatchChange(f);return!1},placeholdDeletes:function(){var a=this;this.isPlaceholdingDeletes&&this.revertDeletePlaceholders();this.isPlaceholdingDeletes=!0;this._deletes=[];var b="."+this._getIceNodeClass("deleteType");ice.dom.each(ice.dom.find(this.element,b),function(b,d){a._deletes.push(ice.dom.cloneNode(d));ice.dom.replaceWith(d,"<"+a._delBookmark+' data-allocation="'+
(a._deletes.length-1)+'"/>')});return!0},revertDeletePlaceholders:function(){var a=this;if(!this.isPlaceholdingDeletes)return!1;ice.dom.each(this._deletes,function(b,f){ice.dom.find(a.element,a._delBookmark+"[data-allocation="+b+"]").replaceWith(f)});this.isPlaceholdingDeletes=!1;return!0},deleteContents:function(a,b){var f=!0;b?this.selection.addRange(b):b=this.getCurrentRange();var e=this.startBatchChange(this.changeTypes.deleteType.alias);b.collapsed===!1?this._deleteFromSelection(b):f=a?this._deleteFromRight(b):
this._deleteFromLeft(b);this.selection.addRange(b);this.endBatchChange(e);return f},getChanges:function(){return this._changes},getElementContent:function(){return this.element.innerHTML},getCleanContent:function(a,b,f){var e="",h=this;ice.dom.each(this.changeTypes,function(a,b){a!="deleteType"&&(b>0&&(e+=","),e+="."+h._getIceNodeClass(a))});a=a?typeof a==="string"?ice.dom.create("<div>"+a+"</div>"):ice.dom.cloneNode(a)[0]:ice.dom.cloneNode(this.element)[0];a=f?f.call(this,a):a;f=ice.dom.find(a,e);
ice.dom.each(f,function(){ice.dom.replaceWith(this,ice.dom.contents(this))});f=ice.dom.find(a,"."+this._getIceNodeClass("deleteType"));ice.dom.remove(f);a=b?b.call(this,a):a;return a.innerHTML},acceptAll:function(){this.element.innerHTML=this.getCleanContent()},rejectAll:function(){var a="."+this._getIceNodeClass("insertType"),b="."+this._getIceNodeClass("deleteType");ice.dom.remove(ice.dom.find(this.element,a));ice.dom.each(ice.dom.find(this.element,b),function(a,b){ice.dom.replaceWith(b,ice.dom.contents(b))})},
acceptChange:function(a){this.acceptRejectChange(a,!0)},rejectChange:function(a){this.acceptRejectChange(a,!1)},acceptRejectChange:function(a,b){var f,e,h,j,l,r,n=ice.dom;if(!a)if(f=this.getCurrentRange(),f.collapsed)a=f.startContainer;else return;f=h="."+this._getIceNodeClass("deleteType");e=j="."+this._getIceNodeClass("insertType");l=n.getNode(a,f+","+e);r=n.find(this.element,"["+this.changeIdAttribute+"="+n.attr(l,this.changeIdAttribute)+"]");b||(h=e,j=f);ice.dom.is(l,j)?n.each(r,function(a,b){n.replaceWith(b,
ice.dom.contents(b))}):n.is(l,h)&&n.remove(r)},isInsideChange:function(a){var b="."+this._getIceNodeClass("insertType")+", ."+this._getIceNodeClass("deleteType");if(!a)if(range=this.getCurrentRange(),range.collapsed)a=range.startContainer;else return!1;return!!ice.dom.getNode(a,b)},addChangeType:function(a,b,f){this.changeTypes[a]={tag:b,alias:f}},getIceNode:function(a,b){var f="."+this._getIceNodeClass(b);return ice.dom.getNode(a,f)},_moveRangeToValidTrackingPos:function(a){for(var b=!1,f=this._getVoidElement(a.endContainer);f;){try{a.moveEnd(ice.dom.CHARACTER_UNIT,
1),a.moveEnd(ice.dom.CHARACTER_UNIT,-1)}catch(e){b=!0}if(b||ice.dom.onBlockBoundary(a.endContainer,a.startContainer,this.blockEl)){a.setStartAfter(f);a.collapse(!0);break}(f=this._getVoidElement(a.endContainer))?(a.setEnd(a.endContainer,0),a.moveEnd(ice.dom.CHARACTER_UNIT,ice.dom.getNodeTextContent(a.endContainer).length),a.collapse()):(a.setStart(a.endContainer,0),a.collapse(!0))}},_getNoTrackElement:function(a){var b=this._getNoTrackSelector();return ice.dom.is(a,b)?a:ice.dom.parents(a,b)[0]||null},
_getNoTrackSelector:function(){return'.ins[userid="'+this.currentUser.id+'"],'+this.noTrack},_getVoidElement:function(a){var b=this._getVoidElSelector();return ice.dom.is(a,b)?a:ice.dom.parents(a,b)[0]||null},_getVoidElSelector:function(){return"."+this._getIceNodeClass("deleteType")+","+this.avoid},_currentUserIceNode:function(a){return ice.dom.attr(a,this.userIdAttribute)==this.currentUser.id},_getChangeTypeFromAlias:function(a){var b,f=null;for(b in this.changeTypes)this.changeTypes.hasOwnProperty(b)&&
this.changeTypes[b].alias==a&&(f=b);return f},_getIceNodeClass:function(a){return this.attrValuePrefix+this.changeTypes[a].alias},getUserStyle:function(a){var b=null;return b=this._userStyles[a]?this._userStyles[a]:this.setUserStyle(a,this.getNewStyleId())},setUserStyle:function(a,b){var f=this.stylePrefix+"-"+b;this._styles[b]||(this._styles[b]=!0);return this._userStyles[a]=f},getNewStyleId:function(){var a=++this._uniqueStyleIndex;return this._styles[a]?this.getNewStyleId():(this._styles[a]=!0,
a)},addChange:function(a,b){var f=this._batchChangeid||this.getNewChangeId();this._changes[f]||(this._changes[f]={type:this._getChangeTypeFromAlias(a),time:(new Date).getTime(),userid:this.currentUser.id,username:this.currentUser.name});var e=this;ice.dom.foreach(b,function(a){e.addNodeToChange(f,b[a])});return f},addNodeToChange:function(a,b){if(this._batchChangeid!==null)a=this._batchChangeid;var f=this.getChange(a);b.getAttribute(this.changeIdAttribute)||b.setAttribute(this.changeIdAttribute,a);
b.getAttribute(this.userIdAttribute)||b.setAttribute(this.userIdAttribute,f.userid);b.getAttribute(this.userNameAttribute)||b.setAttribute(this.userNameAttribute,f.username);b.getAttribute(this.timeAttribute)||b.setAttribute(this.timeAttribute,f.time);ice.dom.hasClass(b,this._getIceNodeClass(f.type))||ice.dom.addClass(b,this._getIceNodeClass(f.type));f=this.getUserStyle(f.userid);ice.dom.hasClass(b,f)||ice.dom.addClass(b,f)},getChange:function(a){var b=null;this._changes[a]&&(b=this._changes[a]);
return b},getNewChangeId:function(){var a=++this._uniqueIDIndex;this._changes[a]&&(a=this.getNewChangeId());return a},startBatchChange:function(){return this._batchChangeid=this.getNewChangeId()},endBatchChange:function(a){if(a===this._batchChangeid)this._batchChangeid=null},getCurrentRange:function(){return this.selection.getRangeAt(0)},_insertNode:function(a,b,f){var e=this._currentUserIceNode(this.getIceNode(b.startContainer,"insertType"));if(!f||!e)e||(a=this.createIceNode("insertType",a)),b.insertNode(a),
b.setEnd(a,1),b.collapse(),f&&(b.setStart(a,0),b.setEnd(a,1)),this.selection.addRange(b)},_deleteFromSelection:function(a){for(var b=new ice.Bookmark(this.env,a),f=ice.dom.getElementsBetween(b.start,b.end),e=ice.dom.parents(a.startContainer,this.blockEl)[0],h=ice.dom.parents(a.endContainer,this.blockEl)[0],j=[],l=f.length,l=f.length,r=0;r<l;r++){var n=f[r];ice.dom.is(n,this.blockEl)&&j.push(n);if(!(n.nodeType===ice.dom.TEXT_NODE&&ice.dom.getNodeTextContent(n)==="")){if(n.hasChildNodes())for(var s=
0;s<n.childNodes.length;s++){var o=n.childNodes[s];this._getNoTrackElement(o)&&ice.dom.remove(o)}this._getNoTrackElement(n)&&ice.dom.remove(n);if(!this._getVoidElement(n)){if(n.nodeType!==ice.dom.TEXT_NODE)if(ice.dom.remove(ice.dom.find(n,"br")),s=ice.dom.cloneNode(n),ice.dom.remove(ice.dom.find(s,this._getVoidElSelector())),ice.dom.getNodeTextContent(s).length===0)continue;else if(ice.dom.is(n,this.blockEl)){s=this.createIceNode("deleteType");newEl=document.createElement(this.blockEl);s.innerHTML=
n.innerHTML;n.innerHTML="";n.appendChild(s);continue}s=this.createIceNode("deleteType");ice.dom.insertBefore(n,s);s.appendChild(n)}}}if(e!==h){for(;j.length;)ice.dom.mergeContainers(j.shift(),e);ice.dom.mergeContainers(h,e)}(f=b.start.previousSibling)?(b.selectBookmark(),a=this.getCurrentRange(),a.moveStart(ice.dom.CHARACTER_UNIT,-1),a.moveStart(ice.dom.CHARACTER_UNIT,1)):(f=this.env.document.createTextNode(""),ice.dom.insertBefore(b.start,f),this.selection.addRange(a),b.selectBookmark(),a=this.getCurrentRange(),
a.setStart(f,0));a.collapse(!0)},_deleteFromRight:function(a){var b=ice.dom.parents(a.startContainer,this.blockEl)[0]||ice.dom.is(a.startContainer,this.blockEl)&&a.startContainer||null,f=b&&b.nextSibling||null,e=ice.dom.is(a.startContainer,this.blockEl)&&ice.dom.getNodeTextContent(a.startContainer)=="";a.moveEnd(ice.dom.CHARACTER_UNIT,1);a.moveEnd(ice.dom.CHARACTER_UNIT,-1);if(!f&&!ice.dom.isChildOf(a.endContainer,this.element))return a.moveEnd(ice.dom.CHARACTER_UNIT,-1),a.moveEnd(ice.dom.CHARACTER_UNIT,
1),a.collapse(),!0;if(ice.dom.onBlockBoundary(a.endContainer,a.startContainer,this.blockEl)||e)return f!==ice.dom.parents(a.endContainer,this.blockEl)[0]&&a.setEnd(f,0),ice.dom.remove(ice.dom.find(a.startContainer,"br")),ice.dom.mergeBlockWithSibling(a,ice.dom.parents(a.startContainer,this.blockEl)[0]||b,!0);if(this._getVoidElement(a.endContainer))return a.setEnd(a.endContainer,0),a.moveEnd(ice.dom.CHARACTER_UNIT,ice.dom.getNodeTextContent(a.endContainer).length||0),a.collapse(),this._deleteFromRight(a);
if(this._getNoTrackElement(a.endContainer.parentElement))return a.deleteContents(),!1;a.collapse();b=a.startContainer;if(a.startContainer.data&&a.endOffset===b.data.length){f=a.cloneRange();f.moveEnd(ice.dom.CHARACTER_UNIT,1);if(e=ice.dom.getBlockParent(f.endContainer,this.element)){if(ice.dom.isChildOf(e,this.element)===!1)return;var h=ice.dom.getBlockParent(f.startContainer,this.element);if(e!==h){ice.dom.mergeContainers(e,h);a.setStart(f.startContainer,f.startContainer.data.length);a.collapse(!0);
return}}b=a.getNextContainer(b);if(ice.dom.isChildOf(b,this.element)===!1)return!1;b=a.getFirstSelectableChild(b);a.setStart(b,0);this._addTextNodeTracking(b,a)}else if(b=this.getIceNode(a.startContainer,"insertType"),b===null||!this._currentUserIceNode(b))this._addTextNodeTracking(a.startContainer,a,!0);else if(a.moveEnd(ice.dom.CHARACTER_UNIT,1),a.deleteContents(),b!==null&&ice.dom.isBlank(ice.dom.getNodeTextContent(b))===!0){f=b.previousSibling;if(!f||f.nodeType!==ice.dom.TEXT_NODE)f=this.env.document.createTextNode(""),
ice.dom.insertBefore(b,f);a.setStart(f,f.data.length);ice.dom.remove(b)}a.collapse(!0);return!0},_deleteFromLeft:function(a){var b=ice.dom.parents(a.startContainer,this.blockEl)[0]||ice.dom.is(a.startContainer,this.blockEl)&&a.startContainer||null,f=b&&b.previousSibling||null,e=ice.dom.is(a.startContainer,this.blockEl)&&ice.dom.getNodeTextContent(a.startContainer)=="";a.moveStart(ice.dom.CHARACTER_UNIT,-1);var h=a.startOffset===a.endOffset&&a.startContainer===a.endContainer,j=!ice.dom.isChildOf(a.startContainer,
this.element);if(h||!f&&j)return f&&a.moveStart(ice.dom.CHARACTER_UNIT,1),a.collapse(!0),!0;a.moveStart(ice.dom.CHARACTER_UNIT,1);if((ice.dom.onBlockBoundary(a.startContainer,a.endContainer,this.blockEl)||e)&&ice.dom.is(f,this.cmsBlock))return a.deleteContents(),!1;if(this._getVoidElement(a.startContainer))return a.setStart(a.startContainer,0),a.collapse(!0),this._deleteFromLeft(a);if(ice.dom.onBlockBoundary(a.startContainer,a.endContainer,this.blockEl)||e)return f!==ice.dom.parents(a.startContainer,
this.blockEl)[0]&&a.setStart(f,0),ice.dom.remove(ice.dom.find(a.endContainer,"br")),ice.dom.mergeBlockWithSibling(a,ice.dom.parents(a.endContainer,this.blockEl)[0]||b);if(this._getNoTrackElement(a.startContainer.parentElement))return a.deleteContents(),!1;b=a.startContainer;if(a.startOffset===0){f=a.cloneRange();f.moveStart(ice.dom.CHARACTER_UNIT,-1);if(e=ice.dom.getBlockParent(f.startContainer,this.element)){if(ice.dom.isChildOf(e,this.element)===!1)return!1;h=ice.dom.getBlockParent(f.endContainer,
this.element);if(h!==e){ice.dom.mergeContainers(h,e);a.setStart(f.startContainer,f.startContainer.data.length);a.collapse(!0);return}}b=a.getPreviousContainer(b);if(!ice.dom.isChildOf(b,this.element))return!1;ice.dom.isStubElement(b)?(a.moveStart(ice.dom.CHARACTER_UNIT,-1),ice.dom.addClass(b,this._getIceNodeClass("deleteType")),ice.dom.attr(b,"title","Content removed"),a.collapse(!0)):(b=a.getLastSelectableChild(b),a.setStart(b,b.data.length),this._addTextNodeTracking(b,a))}else f=a.startContainer,
b=this.getIceNode(f,"insertType"),b===null||!this._currentUserIceNode(b)?this._addTextNodeTracking(f,a):(a.moveStart(ice.dom.CHARACTER_UNIT,-1),a.moveEnd(ice.dom.CHARACTER_UNIT,-1),a.moveEnd(ice.dom.CHARACTER_UNIT,1),a.deleteContents(),b!==null&&ice.dom.isBlank(ice.dom.getNodeTextContent(b))&&(f=this.env.document.createTextNode(""),ice.dom.insertBefore(b,f),a.setStart(f,0),a.collapse(!0),ice.dom.replaceWith(b,ice.dom.contents(b))));return!0},_addTextNodeTracking:function(a,b,f){if(!(!f&&b.startOffset===
0||this.getIceNode(a,"deleteType")!==null)){var e="",h="",j="";f?(e=a.nodeValue.substring(0,b.endOffset),h=a.nodeValue.substr(b.endOffset,1),j=a.nodeValue.substring(b.endOffset+1)):(e=a.nodeValue.substring(0,b.startOffset-1),h=a.nodeValue.substr(b.startOffset-1,1),j=a.nodeValue.substring(b.startOffset));if(b.startOffset===1&&!f||f&&b.startOffset===0){var l=this.getIceNode(a.previousSibling,"deleteType");l!==null&&!this._currentUserIceNode(l)&&(l=null);if(l){if(f)if(l.lastChild&&l.lastChild.nodeType===
ice.dom.TEXT_NODE?l.lastChild.nodeValue+=h:(f=this.env.document.createTextNode(h),l.appendChild(f)),a.nodeValue=e+j,a.nodeValue.length===0){f=!1;for(a=a.nextSibling;!f;)(l=this.getIceNode(a,"deleteType"))?a=a.nextSibling:f=!0;a&&(b.setStart(a,0),b.collapse(!0))}else b.setStart(a,0),b.collapse(!0);else if(l.lastChild&&l.lastChild.nodeType===ice.dom.TEXT_NODE?(l.lastChild.nodeValue+=h,b.setStart(l.lastChild,l.lastChild.nodeValue.length-1)):(f=this.env.document.createTextNode(h),l.appendChild(f),b.setStart(f,
0)),a.nodeValue=e+j,a.nodeValue=e+j,a.nodeValue.length===0){f=!1;for(a=a.previousSibling;!f;)(l=this.getIceNode(a,"deleteType"))?a=a.previousSibling:f=!0;a&&(a=b.getLastSelectableChild(a),b.setStart(a,a.nodeValue.length),b.collapse(!0))}else b.collapse(!0);return}}if(b.startOffset===a.nodeValue.length&&(l=this.getIceNode(a.nextSibling,"deleteType"),l!==null&&!this._currentUserIceNode(l)&&(l=null),l)){l.firstChild&&l.firstChild.nodeType===ice.dom.TEXT_NODE?l.firstChild.nodeValue=h+l.firstChild.nodeValue:
(f=this.env.document.createTextNode(h),ice.dom.insertBefore(l.firstChild,f));a.nodeValue=e;b.setStart(a,a.nodeValue.length);b.setEnd(a,a.nodeValue.length);return}l=this.createIceNode("deleteType");e=null;f!==!0?(e=a.splitText(b.startOffset-1),e.nodeValue=e.nodeValue.substring(1),ice.dom.insertAfter(a,e),l.firstChild.nodeValue=h,ice.dom.insertAfter(a,l),b.setStart(a,a.nodeValue.length),b.setEnd(a,a.nodeValue.length)):(e=a.splitText(b.endOffset),e.nodeValue=e.nodeValue.substring(1),ice.dom.insertAfter(a,
e),l.firstChild.nodeValue=h,ice.dom.insertAfter(a,l),b.setStart(e,0),b.setEnd(e,0))}},_handleAncillaryKey:function(a){var b=!0;switch(a.keyCode){case ice.dom.DOM_VK_DELETE:b=this.deleteContents();this.pluginsManager.fireKeyPressed(a);break;case 46:b=this.deleteContents(!0);this.pluginsManager.fireKeyPressed(a);break;case ice.dom.DOM_VK_DOWN:case ice.dom.DOM_VK_UP:case ice.dom.DOM_VK_LEFT:case ice.dom.DOM_VK_RIGHT:this.pluginsManager.fireCaretPositioned();b=!1;break;default:b=!1}return b===!0?(ice.dom.preventDefault(a),
!1):!0},keyDown:function(a){if(!this.pluginsManager.fireKeyDown(a))return ice.dom.preventDefault(a),!1;var b=!1;if(this._handleSpecialKey(a)===!1){if(ice.dom.isBrowser("msie")!==!0)this._preventKeyPress=!0;return!1}else if((a.ctrlKey===!0||a.metaKey===!0)&&(ice.dom.isBrowser("msie")===!0||ice.dom.isBrowser("chrome")===!0)&&!this.pluginsManager.fireKeyPressed(a))return!1;switch(a.keyCode){case 27:break;default:/Firefox/.test(navigator.userAgent)!==!0&&(b=!this._handleAncillaryKey(a))}return b?(ice.dom.preventDefault(a),
!1):!0},keyPress:function(a){if(this._preventKeyPress===!0)this._preventKeyPress=!1;else{if(!this.pluginsManager.fireKeyPressed(a))return!1;var b=null;a.which==null?b=String.fromCharCode(a.keyCode):a.which>0&&(b=String.fromCharCode(a.which));var f=this.getCurrentRange(),e=ice.dom.parents(f.startContainer,"br")[0]||null;e&&(f.moveToNextEl(e),e.parentNode.removeChild(e));if(b!==null&&a.ctrlKey!==!0&&a.metaKey!==!0)switch(a.keyCode){case ice.dom.DOM_VK_DELETE:break;case ice.dom.DOM_VK_ENTER:return this._handleEnter();
default:return this._moveRangeToValidTrackingPos(f,f.startContainer),this.insert(b)}return this._handleAncillaryKey(a)}},_handleEnter:function(){this.getCurrentRange().collapsed||this.deleteContents();return!0},_handleSpecialKey:function(a){var b=a.which;if(b===null)b=a.keyCode;var f=!1;switch(b){case 65:if(a.ctrlKey===!0||a.metaKey===!0){f=!0;b=this.getCurrentRange();if(ice.dom.isBrowser("msie")===!0){var e=this.env.document.createTextNode(""),h=this.env.document.createTextNode("");this.element.firstChild?
ice.dom.insertBefore(this.element.firstChild,e):this.element.appendChild(e);this.element.appendChild(h);b.setStart(e,0);b.setEnd(h,0)}else b.setStart(b.getFirstSelectableChild(this.element),0),e=b.getLastSelectableChild(this.element),b.setEnd(e,e.length);this.selection.addRange(b)}}return f===!0?(ice.dom.preventDefault(a),!1):!0},mouseUp:function(a){if(!this.pluginsManager.fireClicked(a))return!1;this.pluginsManager.fireSelectionChanged(this.getCurrentRange())},mouseDown:function(a){if(!this.pluginsManager.fireMouseDown(a))return!1;
this.pluginsManager.fireCaretUpdated()}};this.ice=this.ice||{};this.ice.InlineChangeEditor=b}).call(this);
(function(){var e={DOM_VK_DELETE:8,DOM_VK_LEFT:37,DOM_VK_UP:38,DOM_VK_RIGHT:39,DOM_VK_DOWN:40,DOM_VK_ENTER:13,ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12,CHARACTER_UNIT:"character",WORD_UNIT:"word",getKeyChar:function(b){return String.fromCharCode(b.which)},getClass:function(b,a,d){if(!a)a=document.body;b="."+b.split(" ").join(".");
d&&(b=d+b);return jQuery.makeArray(jQuery(a).find(b))},getId:function(b,a){a||(a=document);return element=a.getElementById(b)},getTag:function(b,a){a||(a=document);return jQuery.makeArray(jQuery(a).find(b))},getElementWidth:function(b){return b.offsetWidth},getElementHeight:function(b){return b.offsetHeight},getElementDimensions:function(b){return{width:e.getElementWidth(b),height:e.getElementHeight(b)}},trim:function(b){return jQuery.trim(b)},empty:function(b){if(b)return jQuery(b).empty()},remove:function(b){if(b)return jQuery(b).remove()},
prepend:function(b,a){jQuery(b).prepend(a)},append:function(b,a){jQuery(b).append(a)},insertBefore:function(b,a){jQuery(b).before(a)},insertAfter:function(b,a){jQuery(b).after(a)},getHtml:function(b){return jQuery(b).html()},setHtml:function(b,a){b&&jQuery(b).html(a)},contents:function(b){return jQuery(b).contents()},extractContent:function(b){for(var a=document.createDocumentFragment(),d;d=b.firstChild;)a.appendChild(d);return a}};e.getNode=function(b,a){return e.is(b,a)?b:e.parents(b,a)[0]||null};
e.getParents=function(b,a,d){for(var b=jQuery(b).parents(a),a=b.length,f=[],e=0;e<a;e++){if(b[e]===d)break;f.push(b[e])}return f};e.hasBlockChildren=function(b){for(var a=b.childNodes.length,d=0;d<a;d++)if(b.childNodes[d].nodeType===e.ELEMENT_NODE&&e.isBlockElement(b.childNodes[d])===!0)return!0;return!1};e.removeTag=function(b,a){jQuery(b).find(a).replaceWith(function(){return jQuery(this).contents()});return b};e.stripEnclosingTags=function(b,a){var d=jQuery(b);d.find("*").not(a).replaceWith(function(){return jQuery(this).contents()});
return d[0]};e.getSiblings=function(b,a,d,f){if(d===!0)return a==="prev"?jQuery(b).prevAll():jQuery(b).nextAll();else{d=[];if(a==="prev")for(;b.previousSibling;){b=b.previousSibling;if(b===f)break;d.push(b)}else for(;b.nextSibling;){b=b.nextSibling;if(b===f)break;d.push(b)}return d}};e.getNodeTextContent=function(b){return jQuery(b).text()};e.setNodeTextContent=function(b,a){return jQuery(b).text(a)};e.getTagName=function(b){return b.tagName&&b.tagName.toLowerCase()||null};e.getIframeDocument=function(b){var a=
null;if(b.contentDocument)a=b.contentDocument;else if(b.contentWindow)a=b.contentWindow.document;else if(b.document)a=b.document;return a};e.isBlockElement=function(b){switch(b.nodeName.toLowerCase()){case "p":case "div":case "pre":case "ul":case "ol":case "li":case "table":case "tbody":case "td":case "th":case "fieldset":case "form":case "blockquote":case "dl":case "dir":case "center":case "address":case "h1":case "h2":case "h3":case "h4":case "h5":case "h6":case "img":return!0;default:return!1}};
e.isStubElement=function(b){if(b)switch(b.nodeName.toLowerCase()){case "img":case "br":case "hr":case "iframe":case "param":case "link":case "meta":case "input":case "frame":case "col":case "base":case "area":return!0}return!1};e.isChildOf=function(b,a){try{for(;b&&b.parentNode;){if(b.parentNode===a)return!0;b=b.parentNode}}catch(d){}return!1};e.isChildOfTagName=function(b,a){var d=null;try{for(;b&&b.parentNode;){if(b.parentNode&&b.parentNode.tagName&&b.parentNode.tagName.toLowerCase()===a)d=b.parentNode;
b=b.parentNode}}catch(f){}return d};e.isChildOfClassName=function(b,a){var d=null;try{for(;b&&b.parentNode;){if(jQuery(b.parentNode).hasClass(a))d=b.parentNode;b=b.parentNode}}catch(f){}return d};e.cloneNode=function(b,a){a===void 0&&(a=!0);return jQuery(b).clone(a)};e.bind=function(b,a,d){return jQuery(b).bind(a,d)};e.attr=function(b,a,d){return d?jQuery(b).attr(a,d):jQuery(b).attr(a)};e.replaceWith=function(b,a){return jQuery(b).replaceWith(a)};e.removeAttr=function(b,a){jQuery(b).removeAttr(a)};
e.getElementsBetween=function(b,a){var d=[];if(b===a)return d;if(e.isChildOf(a,b)===!0){for(var f=b.childNodes.length,g=0;g<f;g++)if(b.childNodes[g]===a)break;else if(e.isChildOf(a,b.childNodes[g])===!0)return e.arrayMerge(d,e.getElementsBetween(b.childNodes[g],a));else d.push(b.childNodes[g]);return d}for(f=b.nextSibling;f;)if(e.isChildOf(a,f)===!0)return d=e.arrayMerge(d,e.getElementsBetween(f,a));else if(f===a)return d;else d.push(f),f=f.nextSibling;for(var f=e.getParents(b),g=e.getParents(a),
f=e.arrayDiff(f,g,!0),g=f.length,h=0;h<g-1;h++)d=e.arrayMerge(d,e.getSiblings(f[h],"next"));return d=e.arrayMerge(d,e.getElementsBetween(f[f.length-1],a))};e.getCommonAncestor=function(b,a){for(var d=b;d;){if(e.isChildOf(a,d)===!0)return d;d=d.parentNode}return null};e.getNextNode=function(b){if(b.nextSibling)return b.nextSibling;else if(b.parentNode)return e.getFirstChild(b.parentNode);return null};e.getPrevNode=function(b){if(b.previousSibling)return b.previousSibling;else if(b.parentNode)return e.getLastChild(b.parentNode);
return null};e.getFirstChild=function(b){return b.firstChild?b.firstChild.nodeType===e.ELEMENT_NODE?e.getFirstChild(b.firstChild):b.firstChild:b};e.getLastChild=function(b){return b.lastChild?b.lastChild.nodeType===e.ELEMENT_NODE?e.getLastChild(b.lastChild):b.lastChild:b};e.removeEmptyNodes=function(b,a){for(var d=jQuery(b).find(":empty"),f=d.length;f>0;)f--,e.isStubElement(d[f])===!1&&(!a||a.call(this,d[f])!==!1)&&e.remove(d[f])};e.create=function(b){return jQuery(b)[0]};e.find=function(b,a){return jQuery(b).find(a)};
e.children=function(b,a){return jQuery(b).children(a)};e.parent=function(b,a){return jQuery(b).parent(a)[0]};e.parents=function(b,a){return jQuery(b).parents(a)};e.is=function(b,a){return jQuery(b).is(a)};e.extend=function(b,a,d,f){return jQuery.extend.apply(this,arguments)};e.walk=function(b,a,d){b&&(d||(d=0),a.call(this,b,d)!==!1&&(b.childNodes&&b.childNodes.length>0?e.walk(b.firstChild,a,d+1):b.nextSibling?e.walk(b.nextSibling,a,d):b.parentNode&&b.parentNode.nextSibling&&e.walk(b.parentNode.nextSibling,
a,d-1)))};e.revWalk=function(b,a){b&&a.call(this,b)!==!1&&(b.childNodes&&b.childNodes.length>0?e.walk(b.lastChild,a):b.previousSibling?e.walk(b.previousSibling,a):b.parentNode&&b.parentNode.previousSibling&&e.walk(b.parentNode.previousSibling,a))};e.setStyle=function(b,a,d){b&&jQuery(b).css(a,d)};e.getStyle=function(b,a){return jQuery(b).css(a)};e.hasClass=function(b,a){return jQuery(b).hasClass(a)};e.addClass=function(b,a){jQuery(b).addClass(a)};e.removeClass=function(b,a){jQuery(b).removeClass(a)};
e.preventDefault=function(b){b.preventDefault();e.stopPropagation(b)};e.stopPropagation=function(b){b.stopPropagation()};e.noInclusionInherits=function(b,a){if(a instanceof String||typeof a==="string")a=window[a];if(b instanceof String||typeof b==="string")b=window[b];var d=function(){};if(e.isset(a)===!0)for(value in a.prototype)b.prototype[value]?d.prototype[value]=a.prototype[value]:b.prototype[value]=a.prototype[value];if(b.prototype)d.prototype.constructor=a,b.prototype["super"]=new d};e.each=
function(b,a){jQuery.each(b,function(b,f){a.call(this,b,f)})};e.foreach=function(b,a){if(b instanceof Array||b instanceof NodeList||typeof b.length!="undefined"&&typeof b.item!="undefined")for(var d=b.length,f=0;f<d;f++){var e=a.call(this,f,b[f]);if(e===!1)break}else for(d in b)if(b.hasOwnProperty(d)===!0&&(e=a.call(this,d),e===!1))break};e.isBlank=function(b){return!b||/^\s*$/.test(b)?!0:!1};e.isFn=function(b){return typeof b==="function"?!0:!1};e.isObj=function(b){return b!==null&&typeof b==="object"?
!0:!1};e.isset=function(b){return typeof b!=="undefined"&&b!==null?!0:!1};e.isArray=function(b){return jQuery.isArray(b)};e.isNumeric=function(b){return b.match(/^\d+$/)!==null?!0:!1};e.getUniqueId=function(){return((new Date).getTime()+""+Math.ceil(Math.random()*1E6)).substr(5,18).replace(/,/,"")};e.inArray=function(b,a){for(var d=a.length,f=0;f<d;f++)if(b===a[f])return!0;return!1};e.arrayDiff=function(b,a,d){for(var f=b.length,g=[],h=0;h<f;h++)e.inArray(b[h],a)===!1&&g.push(b[h]);if(d!==!0){f=a.length;
for(h=0;h<f;h++)e.inArray(a[h],b)===!1&&g.push(a[h])}return g};e.arrayMerge=function(b,a){for(var d=a.length,f=0;f<d;f++)b.push(a[f]);return b};e.stripTags=function(b,a){if(typeof a==="string"){var d=jQuery("<div>"+b+"</div>");d.find("*").not(a).remove();return d.html()}else{for(var f=RegExp(/<\/?(\w+)((\s+\w+(\s*=\s*(?:".*?"|'.*?'|[^'">\s]+))?)+\s*|\s*)\/?>/gim),g=b;(d=f.exec(b))!=null;)if(e.isset(a)===!1||e.inArray(d[1],a)!==!0)g=g.replace(d[0],"");return g}};e.browser=function(){var b={};b.version=
jQuery.browser.version;if(jQuery.browser.mozilla===!0)b.type="mozilla";else if(jQuery.browser.msie===!0)b.type="msie";else if(jQuery.browser.opera===!0)b.type="opera";else if(jQuery.browser.safari===!0)b.type="safari";return b};e.getBrowserType=function(){if(this._browserType===null){for(var b=["msie","firefox","chrome","safari"],a=b.length,d=0;d<a;d++)if(RegExp(b[d],"i").test(navigator.userAgent)===!0)return this._browserType=b[d];this._browserType="other"}return this._browserType};e.isBrowser=function(b){return e.browser().type===
b};e.getBlockParent=function(b,a){if(b)for(;b.parentNode;){b=b.parentNode;if(b===a)break;if(e.isBlockElement(b)===!0)return b}return null};e.onBlockBoundary=function(b,a,d){if(!b||!a)return!1;b=e.isChildOfTagName(b,d)||e.is(b,d)&&b||null;a=e.isChildOfTagName(a,d)||e.is(a,d)&&a||null;return b!==a};e.mergeContainers=function(b,a){if(!b||!a)return!1;if(b.nodeType===e.TEXT_NODE||e.isStubElement(b))a.appendChild(b);else if(b.nodeType===e.ELEMENT_NODE){for(;b.firstChild;)a.appendChild(b.firstChild);e.remove(b)}return!0};
e.mergeBlockWithSibling=function(b,a,d){var f=d?a.nextSibling:a.previousSibling;d?e.mergeContainers(f,a):e.mergeContainers(a,f);b.collapse(!0);return!0};e.date=function(b,a,d){if(a===null&&d&&(a=e.tsIso8601ToTimestamp(d),!a))return;for(var a=new Date(a),b=b.split(""),d=b.length,f="",g=0;g<d;g++){var h="",j=b[g];switch(j){case "D":case "l":h=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][a.getDay()];j==="D"&&(h=h.substring(0,3));break;case "F":case "m":h=a.getMonth()+1;h<
10&&(h="0"+h);break;case "M":months=["January","February","March","April","May","June","July","August","September","October","November","December"];h=months[a.getMonth()];j==="M"&&(h=h.substring(0,3));break;case "d":h=a.getDate();break;case "S":h=e.getOrdinalSuffix(a.getDate());break;case "Y":h=a.getFullYear();break;case "y":h=a.getFullYear();h=h.toString().substring(2);break;case "H":h=a.getHours();break;case "h":h=a.getHours();h===0?h=12:h>12&&(h-=12);break;case "i":h=e.addNumberPadding(a.getMinutes());
break;case "a":h="am";a.getHours()>=12&&(h="pm");break;default:h=j}f+=h}return f};e.getOrdinalSuffix=function(b){var a="",a=b%100;if(a>=4&&a<=20)a="th";else switch(b%10){case 1:a="st";break;case 2:a="nd";break;case 3:a="rd";break;default:a="th"}return a};e.addNumberPadding=function(b){b<10&&(b="0"+b);return b};e.tsIso8601ToTimestamp=function(b){if(b=b.match(RegExp(/(\d\d\d\d)(?:-?(\d\d)(?:-?(\d\d)(?:[T ](\d\d)(?::?(\d\d)(?::?(\d\d)(?:\.(\d+))?)?)?(?:Z|(?:([-+])(\d\d)(?::?(\d\d))?)?)?)?)?)?/))){var a=
new Date;a.setDate(b[3]);a.setFullYear(b[1]);a.setMonth(b[2]-1);a.setHours(b[4]);a.setMinutes(b[5]);a.setSeconds(b[6]);var d=b[9]*60;b[8]==="+"&&(d*=-1);d-=a.getTimezoneOffset();return a.getTime()+d*6E4}return null};this.dom=e}).call(this.ice);
(function(){var e;e=function(b,a,d){this.env=b;this.element=b.element;this.selection=this.env.selection;d||this.removeBookmarks(this.element);var b=a||this.selection.getRangeAt(0),a=b.cloneRange(),f=a.startContainer,e=a.startOffset;a.collapse(!1);d=this.env.document.createElement("span");d.style.display="none";ice.dom.setHtml(d,"&nbsp;");ice.dom.addClass(d,"iceBookmark iceBookmark_end");d.setAttribute("iceBookmark","end");a.insertNode(d);ice.dom.isChildOf(d,this.element)||this.element.appendChild(d);
a.setStart(f,e);a.collapse(!0);f=this.env.document.createElement("span");f.style.display="none";ice.dom.addClass(f,"iceBookmark iceBookmark_start");ice.dom.setHtml(f,"&nbsp;");f.setAttribute("iceBookmark","start");try{a.insertNode(f),f.previousSibling===d&&(a=f,f=d,d=a)}catch(h){ice.dom.insertBefore(d,f)}ice.dom.isChildOf(f,this.element)===!1&&(this.element.firstChild?ice.dom.insertBefore(this.element.firstChild,f):this.element.appendChild(f));d.previousSibling||(a=this.env.document.createTextNode(""),
ice.dom.insertBefore(d,a));f.nextSibling||(a=this.env.document.createTextNode(""),ice.dom.insertAfter(f,a));b.setStart(f.nextSibling,0);b.setEnd(d.previousSibling,d.previousSibling.length||0);this.start=f;this.end=d};e.prototype={selectBookmark:function(){var b=this.selection.getRangeAt(0),a=null,d=null,f=0,e=null;if(this.start.nextSibling===this.end||ice.dom.getElementsBetween(this.start,this.end).length===0)if(this.end.nextSibling)a=ice.dom.getFirstChild(this.end.nextSibling);else if(this.start.previousSibling){if(a=
ice.dom.getFirstChild(this.start.previousSibling),a.nodeType===ice.dom.TEXT_NODE)f=a.length}else this.end.parentNode.appendChild(this.env.document.createTextNode("")),a=ice.dom.getFirstChild(this.end.nextSibling);else this.start.nextSibling?a=ice.dom.getFirstChild(this.start.nextSibling):(this.start.previousSibling||(a=this.env.document.createTextNode(""),ice.dom.insertBefore(this.start,a)),a=ice.dom.getLastChild(this.start.previousSibling),f=a.length),this.end.previousSibling?d=ice.dom.getLastChild(this.end.previousSibling):
(d=ice.dom.getFirstChild(this.end.nextSibling),e=0);ice.dom.remove([this.start,this.end]);d===null?(b.setEnd(a,f),b.collapse(!1)):(b.setStart(a,f),e===null&&(e=d.length||0),b.setEnd(d,e));try{this.selection.addRange(b)}catch(h){}},getBookmark:function(b,a){return ice.dom.getClass("iceBookmark_"+a,b)[0]},removeBookmarks:function(b){ice.dom.remove(ice.dom.getClass("iceBookmark",b,"span"))}};this.Bookmark=e}).call(this.ice);
(function(){var e;e=function(b){this._selection=null;this.env=b;this._initializeRangeLibrary();this._selection=this.env.frame?rangy.getIframeSelection(this.env.frame):rangy.getSelection()};e.prototype={_getSelection:function(){this._selection?this._selection.refresh():this._selection=this.env.frame?rangy.getIframeSelection(this.env.frame):rangy.getSelection();return this._selection},createRange:function(){return rangy.createRange(this.env.document)},getRangeAt:function(b){this._selection.refresh();
try{return this._selection.getRangeAt(b)}catch(a){return this.createRange()}},addRange:function(b){this._selection||(this._selection=this._getSelection());this._selection.setSingleRange(b);this._selection.ranges=[b]},_initializeRangeLibrary:function(){var b=this;rangy.init();rangy.config.checkSelectionRanges=!1;rangy.rangePrototype.moveStart=function(a,b){if(b===0)throw Error("InvalidArgumentException: units cannot be 0");switch(a){case ice.dom.CHARACTER_UNIT:b>0?this.moveCharRight(!0,b):this.moveCharLeft(!0,
b)}};rangy.rangePrototype.moveEnd=function(a,b){if(b===0)throw Error("InvalidArgumentException: units cannot be 0");switch(a){case ice.dom.CHARACTER_UNIT:b>0?this.moveCharRight(!1,b):this.moveCharLeft(!1,b)}};rangy.rangePrototype.setRange=function(a,b,f){a?this.setStart(b,f):this.setEnd(b,f)};rangy.rangePrototype.moveCharLeft=function(a,b){var f,e;a?(f=this.startContainer,e=this.startOffset):(f=this.endContainer,e=this.endOffset);e+=b;if(e<0)for(;e<0;){var h=[];if(!this.getPreviousContainer(f,h)){if(b===
-1)return;e=0;break}f=this.getPreviousContainer(f,h);if(f.nodeType!==ice.dom.ELEMENT_NODE)e=f.data.length,e--}this.setRange(a,f,e)};rangy.rangePrototype.moveCharRight=function(a,b){var f,e;a?(f=this.startContainer,e=this.startOffset):(f=this.endContainer,e=this.endOffset);f.nodeType===ice.dom.ELEMENT_NODE?(f=f.childNodes[e],f.nodeType!==ice.dom.TEXT_NODE&&(f=this.getNextTextNode(f)),e=b):e+=b;var h=e-f.data.length;if(h>0){for(e=[];h>0;)if(f=this.getNextContainer(f,e),f.nodeType!==ice.dom.ELEMENT_NODE)if(f.data.length>=
h)break;else f.data.length>0&&(h-=f.data.length);e=h}this.setRange(a,f,e)};rangy.rangePrototype.getNextContainer=function(a,b){if(!a)return null;for(;a.nextSibling;)if(a=a.nextSibling,a.nodeType!==ice.dom.TEXT_NODE){var f=this.getFirstSelectableChild(a);if(f!==null)return f}else if(this.isSelectable(a)===!0)return a;for(;a&&!a.nextSibling;)a=a.parentNode;if(!a)return null;a=a.nextSibling;if(this.isSelectable(a)===!0)return a;else b&&ice.dom.isBlockElement(a)===!0&&b.push(a);f=this.getFirstSelectableChild(a);
return f!==null?f:this.getNextContainer(a,b)};rangy.rangePrototype.getPreviousContainer=function(a,b){if(!a)return null;for(;a.previousSibling;)if(a=a.previousSibling,a.nodeType!==ice.dom.TEXT_NODE)if(ice.dom.isStubElement(a)===!0)return a;else{var f=this.getLastSelectableChild(a);if(f!==null)return f}else if(this.isSelectable(a)===!0)return a;for(;a&&!a.previousSibling;)a=a.parentNode;if(!a)return null;a=a.previousSibling;if(this.isSelectable(a)===!0)return a;else b&&ice.dom.isBlockElement(a)===
!0&&b.push(a);f=this.getLastSelectableChild(a);return f!==null?f:this.getPreviousContainer(a,b)};rangy.rangePrototype.getStartOffset=function(a){if(a===!0)return this.startOffset;for(var a=0,b=this.startContainer,f=b.data.charCodeAt(0);f===10||f===32;)a++,f=b.data.charCodeAt(a);return this.startOffset-a};rangy.rangePrototype.getNextTextNode=function(a){if(a.nodeType===ice.dom.ELEMENT_NODE&&a.childNodes.length!==0)return this.getFirstSelectableChild(a);a=this.getNextContainer(a);return a.nodeType===
ice.dom.TEXT_NODE?a:this.getNextTextNode(a)};rangy.rangePrototype.getFirstSelectableChild=function(a){if(a)if(a.nodeType!==ice.dom.TEXT_NODE)for(a=a.firstChild;a;)if(this.isSelectable(a)===!0)return a;else if(a.firstChild){var b=this.getFirstSelectableChild(a);if(b!==null)return b;else a=a.nextSibling}else a=a.nextSibling;else return a;return null};rangy.rangePrototype.getLastSelectableChild=function(a){if(a)if(a.nodeType!==ice.dom.TEXT_NODE)for(a=a.lastChild;a;)if(this.isSelectable(a)===!0)return a;
else if(a.lastChild){var b=this.getLastSelectableChild(a);if(b!==null)return b;else a=a.previousSibling}else a=a.previousSibling;else return a;return null};rangy.rangePrototype.isSelectable=function(a){return a&&a.nodeType===ice.dom.TEXT_NODE&&a.data.length!==0?!0:!1};rangy.rangePrototype.getHTMLContents=function(a){a||(a=this.cloneContents());var d=b.env.document.createElement("div");d.appendChild(a.cloneNode(!0));return d.innerHTML};rangy.rangePrototype.getHTMLContentsObj=function(){return this.cloneContents()}}};
this.Selection=e}).call(this.ice);
(function(){var e=function(b){this._ice=b};e.prototype={start:function(){},clicked:function(){return!0},mouseDown:function(){return!0},keyDown:function(){return!0},keyPress:function(){return!0},selectionChanged:function(){},setEnabled:function(){},setDisabled:function(){},caretUpdated:function(){},nodeInserted:function(){},nodeCreated:function(){},caretPositioned:function(){},remove:function(){this._ice.removeKeyPressListener(this)},setSettings:function(){}};this.IcePlugin=e}).call(this.ice);
(function(){var e=function(b){this.plugins={};this.pluginConstructors={};this.keyPressListeners={};this.activePlugin=null;this.pluginSets={};this.activePluginSet=null;this._ice=b};e.prototype={getPluginNames:function(){var b=[],a;for(a in this.plugins)b.push(a);return b},addPluginObject:function(b,a){this.plugins[b]=a},addPlugin:function(b,a){if(typeof a!=="function")throw Error("IcePluginException: plugin must be a constructor function");ice.dom.isset(this.pluginConstructors[b])===!1&&(this.pluginConstructors[b]=
a)},loadPlugins:function(b,a){if(b.length===0)a.call(this);else{var d=b.shift();if(typeof d==="object")d=d.name;if(ice.dom.isset(ice._plugin[d])===!0)this.addPlugin(d,ice._plugin[d]),this.loadPlugins(b,a);else throw Error("plugin was not included in the page: "+d);}},_enableSet:function(b){this.activePluginSet=b;for(var a=this.pluginSets[b].length,d=0;d<a;d++){var f=this.pluginSets[b][d],e="",e=typeof f==="object"?f.name:f,h=this.pluginConstructors[e];h&&(h=new h(this._ice),this.plugins[e]=h,ice.dom.isset(f.settings)===
!0&&h.setSettings(f.settings),h.start())}},setActivePlugin:function(b){this.activePlugin=b},getActivePlugin:function(){return this.activePlugin},_getPluginName:function(b){b=b.toString();return b.substr(9,b.indexOf("(")-9)},removePlugin:function(b){this.plugins[b]&&this.plugins[b].remove()},getPlugin:function(b){return this.plugins[b]},usePlugins:function(b,a,d){var f=this;this.pluginSets[b]=ice.dom.isset(a)===!0?a:[];this.loadPlugins(this.pluginSets[b].concat([]),function(){f._enableSet(b);d&&d.call(this)})},
disablePlugin:function(b){this.plugins[b].disable()},isPluginElement:function(b){for(var a in this.plugins)if(this.plugins[a].isPluginElement&&this.plugins[a].isPluginElement(b)===!0)return!0;return!1},fireKeyPressed:function(b){if(this._fireKeyPressFns(b,"all_keys")===!1)return!1;var a=[];(b.ctrlKey===!0||b.metaKey===!0)&&a.push("ctrl");b.shiftKey===!0&&a.push("shift");b.altKey===!0&&a.push("alt");switch(b.keyCode){case 13:a.push("enter");break;case ice.dom.DOM_VK_LEFT:a.push("left");break;case ice.dom.DOM_VK_RIGHT:a.push("right");
break;case ice.dom.DOM_VK_UP:a.push("up");break;case ice.dom.DOM_VK_DOWN:a.push("down");break;case 9:a.push("tab");break;case ice.dom.DOM_VK_DELETE:a.push("delete");break;default:var d;if(b.keyCode)d=b.keyCode;else if(b.which)d=b.which;d&&a.push(String.fromCharCode(d).toLowerCase())}a=a.sort().join("+");return this._fireKeyPressFns(b,a)},_fireKeyPressFns:function(b,a){if(this.keyPressListeners[a])for(var d=this.keyPressListeners[a].length,f=0;f<d;f++){var e=this.keyPressListeners[a][f],h=e.fn,j=e.plugin,
e=e.data;if(h)if(ice.dom.isFn(h)===!0){if(h.call(j,b,e)===!0)return ice.dom.preventDefault(b),!1}else if(j[h]&&j[h].call(j,b,e)===!0)return ice.dom.preventDefault(b),!1}return!0},fireSelectionChanged:function(b){for(var a in this.plugins)this.plugins[a].selectionChanged(b)},fireNodeInserted:function(b,a){for(var d in this.plugins)if(this.plugins[d].nodeInserted(b,a)===!1)return!1},fireNodeCreated:function(b,a){for(var d in this.plugins)if(this.plugins[d].nodeCreated(b,a)===!1)return!1},fireCaretPositioned:function(){for(var b in this.plugins)this.plugins[b].caretPositioned()},
fireClicked:function(b){var a=!0,d;for(d in this.plugins)this.plugins[d].clicked(b)===!1&&(a=!1);return a},fireMouseDown:function(b){var a=!0,d;for(d in this.plugins)this.plugins[d].mouseDown(b)===!1&&(a=!1);return a},fireKeyDown:function(b){var a=!0,d;for(d in this.plugins)this.plugins[d].keyDown(b)===!1&&(a=!1);return a},fireKeyPress:function(b){var a=!0,d;for(d in this.plugins)this.plugins[d].keyPress(b)===!1&&(a=!1);return a},fireEnabled:function(b){for(var a in this.plugins)this.plugins[a].setEnabled(b)},
fireDisabled:function(b){for(var a in this.plugins)this.plugins[a].setDisabled(b)},fireCaretUpdated:function(){for(var b in this.plugins)this.plugins[b].caretUpdated&&this.plugins[b].caretUpdated()}};this._plugin={};this.IcePluginManager=e}).call(this.ice);
(function(){var e;e=function(b){this._ice=b};e.prototype={nodeCreated:function(b,a){b.setAttribute("title",(a.action||"Modified")+" by "+b.getAttribute(this._ice.userNameAttribute)+" - "+ice.dom.date("m/d/Y h:ia",parseInt(b.getAttribute(this._ice.timeAttribute))))}};ice.dom.noInclusionInherits(e,ice.IcePlugin);this._plugin.IceAddTitlePlugin=e}).call(this.ice);
(function(){var e;e=function(b){this._ice=b;this._tmpNode=null;this._tmpNodeTagName="icepaste";this._pasteId="icepastediv";var a=this;this.pasteType="formattedClean";this.preserve="p";this.beforePasteClean=function(a){return a};this.afterPasteClean=function(a){return a};b.element.oncopy=function(){return a.handleCopy.apply(a)};b.element.oncut=function(){return a.handleCut.apply(a)}};e.prototype={setSettings:function(b){b=b||{};ice.dom.extend(this,b);this.preserve+=","+this._tmpNodeTagName;this.setupPreserved()},
keyDown:function(b){b.metaKey!==!0&&b.ctrlKey!==!0||b.keyCode==86&&this.handlePaste()},handleCut:function(){if(this._ice.isTracking){var b=this._ice.getCurrentRange();if(!b.collapsed){var a=b.cloneContents(),d=this;setTimeout(function(){d.doCut(a)},1);return!0}}},doCut:function(b){var a=this._ice.getCurrentRange(),d,f;this._tmpNode=this._ice.env.document.createElement("span");a.insertNode(this._tmpNode);a.setStartAfter(this._tmpNode);for(a.collapse(!0);d=b.firstChild;)a.insertNode(d),a.setStartAfter(d),
a.collapse(!0),f=d;a.setStartBefore(this._tmpNode);a.collapse(!0);a.setEndAfter(f);this._ice.env.selection.addRange(a);this._ice.deleteContents(null,null,"cutType");ice.dom.remove(this._tmpNode)},handleCopy:function(){},handlePaste:function(){var b=this._ice.getCurrentRange();b.collapsed||(this._ice.isTracking?(this._ice.deleteContents(),b=b.cloneRange()):(b.deleteContents(),b.collapse(!0)));this._ice.isTracking&&this._ice._moveRangeToValidTrackingPos(b);if(b.startContainer==this._ice.element){var a=
ice.dom.find(this._ice.element,this._ice.blockEl)[0];a||(a=ice.dom.create("<"+this._ice.blockEl+" ><br/></"+this._ice.blockEl+">"),this._ice.element.appendChild(a));b.setStart(a,0);b.collapse(!0);this._ice.env.selection.addRange(b)}this._tmpNode=this._ice.env.document.createElement(this._tmpNodeTagName);b.insertNode(this._tmpNode);switch(this.pasteType){case "formatted":this.setupPaste();break;case "formattedClean":this.setupPaste(!0)}return!0},setupPaste:function(b){var a=this.createDiv(this._pasteId),
d=this;a.focus();a.onpaste=function(){setTimeout(function(){d.handlePasteValue(b)},1)};return!0},handlePasteValue:function(b){var a=ice.dom.getHtml(document.getElementById(this._pasteId)),d=ice.dom.children("<div>"+a+"</div>",this._ice.blockEl);d.length===1&&ice.dom.getNodeTextContent("<div>"+a+"</div>")===ice.dom.getNodeTextContent(d)&&(a=ice.dom.getHtml(a));a=this.beforePasteClean.call(this,a);b&&(a=this._ice.getCleanContent(a),a=this.stripPaste(a));var a=this.afterPasteClean.call(this,a),a=ice.dom.trim(a),
f=this._ice.getCurrentRange();f.setStartAfter(this._tmpNode);f.collapse(!0);var e=null,a=f.createContextualFragment(a),b=this._ice.startBatchChange();if(ice.dom.hasBlockChildren(a)){var h=ice.dom.isChildOfTagName(this._tmpNode,this._ice.blockEl);f.setEndAfter(h.lastChild);this._ice.selection.addRange(f);e=f.extractContents();d=this._ice.env.document.createElement(this._ice.blockEl);d.appendChild(e);ice.dom.insertAfter(h,d);f.setStart(d,0);f.collapse(!0);this._ice.selection.addRange(f);for(var f=f.startContainer,
j=null,h=null;a.firstChild;)if(a.firstChild.nodeType===3&&!jQuery.trim(a.firstChild.nodeValue))a.removeChild(a.firstChild);else if(ice.dom.isBlockElement(a.firstChild)){if(a.firstChild.textContent!=="")h=j=null,this._ice.isTracking?(h=this._ice.createIceNode("insertType"),this._ice.addChange("insertType",[h]),e=document.createElement(a.firstChild.tagName),h.innerHTML=a.firstChild.innerHTML,e.appendChild(h)):(h=e=document.createElement(a.firstChild.tagName),e.innerHTML=a.firstChild.innerHTML),ice.dom.insertBefore(f,
e);a.removeChild(a.firstChild)}else j||(e=document.createElement(this._ice.blockEl),ice.dom.insertBefore(f,e),this._ice.isTracking?(j=this._ice.createIceNode("insertType"),this._ice.addChange("insertType",[j]),e.appendChild(j)):j=e),h=j,j.appendChild(a.removeChild(a.firstChild));d.textContent||d.parentNode.removeChild(d)}else if(this._ice.isTracking)e=this._ice.createIceNode("insertType",a),this._ice.addChange("insertType",[e]),f.insertNode(e),h=e;else for(;d=a.firstChild;)f.insertNode(d),f.setStartAfter(d),
f.collapse(!0),h=d;this._ice.endBatchChange(b);this._cleanup(h)},createDiv:function(b){var a=ice.dom.getId(b);if(a)return ice.dom.empty(a),a;a=this._ice.env.document.createElement("div");a.id=b;a.setAttribute("contentEditable",!0);ice.dom.setStyle(a,"width","1px");ice.dom.setStyle(a,"height","1px");ice.dom.setStyle(a,"overflow","hidden");ice.dom.setStyle(a,"position","fixed");ice.dom.setStyle(a,"top","10px");ice.dom.setStyle(a,"left","10px");document.body.appendChild(a);return a},handleCut:function(){this.cutElementId=
"icecut";this.cutElement=this.createDiv(this.cutElementId);var b=this._ice.getCurrentRange();if(!b.collapsed){var a=b.getHTMLContents();this._ice.isTracking?this._ice.deleteContents():b.deleteContents();var d=b.cloneRange();d.collapse(!0);this.cutElement.innerHTML=a;b.setStart(this.cutElement.firstChild,0);b.setEndAfter(this.cutElement.lastChild,this.cutElement.lastChild.length);var f=this;setTimeout(function(){b.setStart(d.startContainer,d.startOffset);b.collapse(!0);f._ice.env.selection.addRange(b);
ice.dom.remove(this.cutElement)},10)}},stripPaste:function(b){b=this._cleanWordPaste(b);return b=this.cleanPreserved(b)},setupPreserved:function(){var b=this;this._tags="";this._attributesMap=[];ice.dom.each(this.preserve.split(","),function(a,d){d.match(/(\w+)(\[(.+)\])?/);var f=RegExp.$1,e=RegExp.$3;b._tags&&(b._tags+=",");b._tags+=f.toLowerCase();b._attributesMap[f]=e.split("|")})},cleanPreserved:function(b){var a=this,d=this._ice.env.document.createElement("div");d.innerHTML=b;d=ice.dom.stripEnclosingTags(d,
this._tags);ice.dom.each(ice.dom.find(d,this._tags),function(b,d){if(ice.dom.hasClass(d,"skip-clean"))return!0;var e=d.tagName.toLowerCase(),e=a._attributesMap[e];if(e[0]&&e[0]==="*")return!0;if(d.hasAttributes())for(var j=d.attributes,b=j.length-1;b>=0;b--)ice.dom.inArray(j[b].name,e)||d.removeAttribute(j[b].name)});return d.innerHTML},_cleanWordPaste:function(b){b=b.replace(/<(meta|link)[^>]+>/g,"");b=b.replace(/<\!--(.|\s)*?--\>/g,"");b=b.replace(/<style>[\s\S]*?<\/style>/g,"");b=b.replace(/<\/?\w+:[^>]*>/gi,
"");b=b.replace(/<\\?\?xml[^>]*>/gi,"");b=this._cleanPaste(b);return b=b.replace(/<(\w[^>]*) (lang)=([^ |>]*)([^>]*)/gi,"<$1$4")},_getListType:function(b,a){var d=ice.dom.getHtml(b),f=null;ice.dom.foreach(a,function(b){ice.dom.foreach(a[b],function(e){ice.dom.foreach(a[b][e],function(j){if(RegExp(a[b][e][j]).test(d)===!0)return f={html:d.replace(RegExp(a[b][e][j]),""),listType:b,listStyle:e},!1});if(f!==null)return!1});if(f!==null)return!1});return f},_cleanPaste:function(b){b=b.replace(/<b(\s+|>)/g,
"<strong$1");b=b.replace(/<\/b(\s+|>)/g,"</strong$1");b=b.replace(/<i(\s+|>)/g,"<em$1");return b=b.replace(/<\/i(\s+|>)/g,"</em$1")},_cleanup:function(b){try{var b=b&&b.lastChild||b||this._tmpNode,a=this._ice.getCurrentRange();a.setStart(b,b.length);a.collapse(!0);this._ice.selection.addRange(a);this._ice.env.frame?this._ice.env.frame.contentWindow.focus():this._ice.element.focus();this._tmpNode.parentNode.removeChild(this._tmpNode);this._tmpNode=null;for(var d=this._ice.env.document.getElementsByClassName(this._ice.changeTypes.insertType.alias),
b=0;b<d.length;b++)d[b].textContent||d[b].parentNode&&d[b].parentNode.removeChild(d[b])}catch(f){window.console&&console.error(f)}}};ice.dom.noInclusionInherits(e,ice.IcePlugin);this._plugin.IceCopyPastePlugin=e}).call(this.ice);
(function(){var e=this.ice,b=function(a){this._ice=a};b.prototype={convert:function(a){var b=this;e.dom.each(a.getElementsByTagName(this._ice.blockEl),function(a,e){try{b._ice.placeholdDeletes(),b._convertBlock(e)}catch(h){console.error(h)}finally{b._ice.revertDeletePlaceholders()}})},_convertBlock:function(a){if(!(a.textContent.length<2)){var b=String.fromCharCode(8216),f=String.fromCharCode(8217),e=String.fromCharCode(8220),h=String.fromCharCode(8221),j=function(a){return a===String.fromCharCode(160)||
a===String.fromCharCode(32)},l=this._ice.selection.createRange(),r=a.cloneNode(!0);l.setStart(r,0);l.collapse(!0);for(var r=[],n=null,s=null,o=null,i=0;;)try{l.moveEnd("character",1),r.push(l.cloneContents().textContent.charAt(i++))}catch(t){break}for(i=0;i<=r.length;i++)switch(n=s,s=o,o=r.length===i?null:r[i],s){case b:case f:this.replaceCharAtPosition("'",i,a);case "'":(n===null||j(n))&&/\d/.test(o)&&/\d/.test(r[i+1])&&j(r[i+2])?this.replaceCharAtPosition(f,i,a):n===null||j(n)&&!j(o)?this.replaceCharAtPosition(b,
i,a):o===null||!j(n)&&j(o)?this.replaceCharAtPosition(f,i,a):/\w/.test(n)&&/\w/.test(o)&&this.replaceCharAtPosition(f,i,a);break;case e:case h:this.replaceCharAtPosition('"',i,a);case '"':n===null||j(n)&&!j(o)?this.replaceCharAtPosition(e,i,a):o===null||!j(n)&&j(o)?this.replaceCharAtPosition(h,i,a):(n===null||j(n))&&j(o)&&(r[i+1]==="'"||r[i+1]===b||r[i+1]===f)?this.replaceCharAtPosition(e,i,a):(o===null||j(o))&&j(n)&&(r[i-3]==="'"||r[i-3]===b||r[i-3]===f)&&this.replaceCharAtPosition(h,i,a)}}},replaceCharAtPosition:function(a,
b,f){var e=this._ice.selection.createRange();for(e.setStart(f,0);b-- >1;)e.moveStart("character",1);try{e.moveStart("character",1),e.moveStart("character",-1)}catch(h){}e.collapse(!0);e.moveEnd("character",1);e.extractContents();this._ice.insert(a,e)}};e.dom.noInclusionInherits(b,e.IcePlugin);this.ice._plugin.IceSmartQuotesPlugin=b}).call(this);
(function(){var e=function(b){this._ice=b};e.prototype={keyDown:function(b){if(ice.dom.isBrowser("mozilla")){var a=parseInt(ice.dom.browser().version);if(a>14&&b.keyCode===173||a<=14&&b.keyCode===109)return this.convertEmdash(b)}else if(b.keyCode===189)return this.convertEmdash(b);return!0},convertEmdash:function(){var b=this._ice.getCurrentRange();if(b.collapsed){try{b.moveStart(ice.dom.CHARACTER_UNIT,-1);var a=ice.dom.getParents(b.startContainer,this._ice.blockEl)[0],d=ice.dom.getParents(b.endContainer,
this._ice.blockEl)[0];if(a===d&&!this._ice.getIceNode(b.startContainer,"deleteType")&&(c=b.toHtml(),c==="-")){b.extractContents();b.collapse();var e=this._ice.env.document.createTextNode("\u2014");this._ice.isTracking?this._ice._insertNode(e,b):(b.insertNode(e),b.setStart(e,1),b.collapse(!0));this._ice._preventKeyPress=!0;return!1}}catch(g){}b.collapse()}return!0}};ice.dom.noInclusionInherits(e,ice.IcePlugin);this._plugin.IceEmdashPlugin=e}).call(this.ice);
